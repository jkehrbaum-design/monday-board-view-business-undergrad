<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bachelor’s Programs – Freshman & Average Student</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2430;
      --muted:#6b7280;
      --line:#e6e9f0;
      --primary:#1f76ff;
      --pill:#eef3ff;
      --pillText:#1f4fbf;
      --link:#1f76ff;
      --thead:#f2f4f8;
      --chip:#f4f6fa;
      --chipText:#49506a;
      --stickyW:280px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    }
    .wrap{ max-width:1200px; margin:24px auto; padding:0 20px; }
    .h1{ font-size:28px; font-weight:700; margin:8px 0 4px; }
    .sub{ color:var(--muted); font-size:13px; margin-bottom:18px; }
    .card{ background:var(--card); border:1px solid var(--line);
      border-radius:10px; padding:14px; margin-bottom:16px;
      box-shadow:0 1px 2px rgba(0,0,0,.03);}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    .col{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; color:var(--muted)}
    input,select{ height:36px; padding:0 10px; border:1px solid var(--line);
      border-radius:8px; background:#fff; color:var(--text); min-width:120px;}
    .nums{width:110px; text-align:right}
    .btn{ height:36px; padding:0 14px; border-radius:8px; border:1px solid var(--line);
      background:#fff; cursor:pointer; font-weight:600;}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .chips{display:flex; gap:8px; align-items:center; font-size:12px}
    .chip{background:var(--chip); color:var(--chipText); padding:4px 8px; border-radius:999px}
    .muted{color:var(--muted)}
    .spacer{flex:1}

    /* TABLE */
    .tableWrap{ background:var(--card); border:1px solid var(--line); border-radius:10px; overflow:auto; position:relative }
    table{border-collapse:separate; border-spacing:0; width:1400px;}
    thead th{ position:sticky; top:0; background:var(--thead); z-index:3;
      font-size:12px; text-transform:uppercase; letter-spacing:.02em;
      color:#49506a; padding:10px; border-bottom:1px solid var(--line);
      user-select:none; cursor:pointer;}
    thead th.sortable::after{ content:" ⇅"; font-size:10px; color:#999; margin-left:4px; }
    tbody td{ padding:12px 10px; border-top:1px solid var(--line); vertical-align:top; font-size:14px;
      max-width:280px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer;}
    .sticky{ position:sticky; left:0; z-index:2; background:#fff; min-width:var(--stickyW); max-width:var(--stickyW);}
    tbody tr:hover td{background:#fafbff}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      border-radius:999px; background:var(--pill); color:var(--pillText); font-size:12px; }
    .link{color:var(--link); text-decoration:none; font-weight:600}
    .mono{font-family: ui-monospace,monospace; font-size:12px}
    .right{text-align:right}

    /* Loader */
    #loader{ position:fixed; top:0; left:0; width:100%; height:100%; background:#fff;
      display:flex; align-items:center; justify-content:center; font-size:20px; z-index:1000;}
    /* Popup */
    #popup{ display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; padding:20px; border:1px solid #ccc; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.2); z-index:2000; max-width:600px; max-height:400px; overflow:auto;}
    #popupClose{ float:right; cursor:pointer; font-weight:bold; }
  </style>
</head>
<body>
<div id="loader">Loading data...</div>
<div class="wrap" style="display:none" id="mainWrap">
  <div class="h1">Bachelor’s Programs – Freshman & Average Student</div>
  <div class="sub">The data is coming from a secure Netlify function (read-only). The layout is inspired by Monday.</div>

  <!-- FILTERS -->
  <div class="card">
    <div class="row">
      <div class="col" style="min-width:260px">
        <label class="label">Search (Name & Major)</label>
        <input id="q" placeholder="Search …" />
      </div>
      <div class="col">
        <label class="label">State</label>
        <select id="state"><option value="">All</option></select>
      </div>
      <div class="col">
        <label class="label">Ranking</label>
        <div class="row" style="gap:6px">
          <input id="rkMin" class="nums" placeholder="min" inputmode="numeric" />
          <input id="rkMax" class="nums" placeholder="max" inputmode="numeric" />
        </div>
      </div>
      <div class="col">
        <label class="label">Final cost (USD)</label>
        <div class="row" style="gap:6px">
          <input id="fcMin" class="nums" placeholder="min $" inputmode="numeric" />
          <input id="fcMax" class="nums" placeholder="max $" inputmode="numeric" />
        </div>
      </div>
      <div class="col">
        <label class="label">GPA</label>
        <div class="row" style="gap:6px">
          <input id="gpaMin" class="nums" placeholder="min" inputmode="decimal" />
          <input id="gpaMax" class="nums" placeholder="max" inputmode="decimal" />
        </div>
      </div>
      <div class="col">
        <label class="label">Page size</label>
        <select id="limit"><option>20</option><option selected>50</option><option>100</option></select>
      </div>
      <div class="spacer"></div>
      <button class="btn primary" id="reloadBtn">Reload</button>
      <button class="btn" id="resetBtn">Reset Filters</button>
      <button class="btn" id="exportBtn">Export Excel</button>
    </div>
    <div class="chips" style="margin-top:10px">
      <span id="shown" class="chip">0 shown</span>
      <span id="loaded" class="chip">0 loaded</span>
      <button id="moreBtn" class="btn" style="height:28px;padding:0 10px">Load more</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="tableWrap">
    <table id="tbl">
      <thead>
        <tr>
          <th class="sticky sortable" data-key="name">Name</th>
          <th class="sortable" data-key="state">State</th>
          <th class="sortable" data-key="major">Major</th>
          <th class="sortable right" data-key="ranking">Ranking</th>
          <th class="sortable right" data-key="final_cost">Final cost</th>
          <th class="sortable right" data-key="gpa">Min GPA</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Popup -->
<div id="popup"><span id="popupClose">X</span><div id="popupContent"></div></div>

<script>
(() => {
  const loader = document.getElementById('loader');
  const mainWrap = document.getElementById('mainWrap');
  const popup = document.getElementById('popup');
  const popupContent = document.getElementById('popupContent');
  const popupClose = document.getElementById('popupClose');

  function showPopup(txt){ popupContent.textContent=txt; popup.style.display='block'; }
  popupClose.onclick=()=>popup.style.display='none';

  function numberFrom(a){ if(a==null) return null; const s=(""+a).replace(/[^\d.\-]/g,''); if(!s) return null; const n=parseFloat(s); return Number.isFinite(n)?n:null; }

  async function fetchBatch({limit,cursorParam}){
    const url=new URL('/.netlify/functions/items',location.origin);
    url.searchParams.set('limit',limit||'50');
    if(cursorParam) url.searchParams.set('cursor',cursorParam);
    const resp=await fetch(url); if(!resp.ok) return {items:[],cursor:null};
    return await resp.json();
  }

  let items=[],cursor=null;

  async function initialLoad(){
    items=[];cursor=null;
    const {items:batch,cursor:cur}=await fetchBatch({limit:limitSel.value});
    items.push(...batch);cursor=cur||null;
    render();
    loader.style.display='none'; mainWrap.style.display='block';
  }

  function render(){
    const rows=items.map(it=>({
      name:it.name,state:it.state,major:it.majors,
      ranking:it.ranking,final_cost:it.totalCost,gpa:it.minGpa
    }));
    tbody.innerHTML=rows.map(r=>`
      <tr>
        <td class="sticky">${esc(r.name)}</td>
        <td>${esc(r.state)}</td>
        <td>${esc(r.major)}</td>
        <td class="right">${r.ranking??""}</td>
        <td class="right">${formatMoney(r.final_cost)}</td>
        <td class="right">${r.gpa??""}</td>
      </tr>`).join('');
    shown.textContent=`${rows.length} shown
