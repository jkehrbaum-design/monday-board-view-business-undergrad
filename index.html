<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bachelor’s Programs – Freshman & Average Student</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f7fb;
    --panel:#fff;
    --text:#1f2430;
    --muted:#707786;
    --border:#e2e6ef;
    --blue:#1976d2;
    --tag:#eef3ff;
    --tag-text:#2b4b9b;
    --header:#f2f4f8;
    --row-hover:#f8fafc;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;
    color:var(--text); line-height:1.4;
  }
  header{ padding:24px; }
  h1{font-size:22px; margin:0 0 8px 0; font-weight:600}
  p.sub{margin:0; color:var(--muted); font-size:14px}

  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:12px;
    box-shadow:0 1px 2px rgba(0,0,0,.03);
    margin:0 24px 24px 24px;
  }
  .controls{
    display:flex; flex-wrap:wrap; gap:12px;
    padding:16px; border-bottom:1px solid var(--border);
  }
  .ctrl{display:flex; flex-direction:column; gap:6px; min-width:220px}
  .ctrl label{font-size:12px; color:var(--muted)}
  .ctrl input[type="text"], .ctrl input[type="number"], .ctrl select{
    padding:10px 12px; border:1px solid var(--border);
    border-radius:8px; background:#fff; font-size:14px;
    outline:none;
  }
  .btn{padding:10px 14px; border:1px solid var(--border);
    background:#fff; color:var(--text);
    border-radius:8px; cursor:pointer; font-size:14px;}
  .btn.primary{background:var(--blue); color:#fff; border-color:var(--blue)}
  .btn:disabled{opacity:.5; cursor:default}
  .badges{margin-left:auto; display:flex; gap:10px; align-items:center}
  .badge{background:#eef1f6; color:#333; padding:6px 10px; border-radius:999px; font-size:12px}

  .table-wrap{overflow:auto}
  table{border-collapse:separate; border-spacing:0; width:max-content; min-width:100%}
  thead th{
    position:sticky; top:0; background:var(--header); z-index:5;
    font-weight:600; font-size:13px; color:#324256;
    padding:12px; border-bottom:1px solid var(--border); border-right:1px solid var(--border);
    white-space:nowrap; cursor:pointer;
  }
  tbody td{
    padding:12px; font-size:14px; color:#1a1f2c;
    border-bottom:1px solid var(--border); border-right:1px solid var(--border);
    vertical-align:top; background:#fff;
  }
  tbody tr:hover td{ background:var(--row-hover) }
  th:first-child, td:first-child{position:sticky; left:0; background:#fff; z-index:4}
  thead th:first-child{z-index:6; background:var(--header)}
  .pill{
    display:inline-block; background:var(--tag); color:var(--tag-text);
    padding:2px 8px; border-radius:999px; font-size:12px; margin:2px 4px 2px 0;
  }
  .mono{font-variant-numeric:tabular-nums}
  .empty{color:var(--muted)}
  .export{margin:8px 16px 16px 16px}
</style>
</head>
<body>

<header>
  <h1>Bachelor’s Programs – Freshman & Average Student</h1>
  <p class="sub">Die Daten kommen aus einer sicheren Netlify-Funktion (read-only).</p>
</header>

<div class="card">
  <div class="controls">
    <div class="ctrl">
      <label>Suche (Name & Major)</label>
      <input id="q" type="text" placeholder="z. B. business, Rowan …">
    </div>

    <div class="ctrl">
      <label>State</label>
      <select id="state">
        <option value="all">all</option>
      </select>
    </div>

    <div class="ctrl">
      <label>Ranking (min – max)</label>
      <div style="display:flex; gap:8px">
        <input id="rankMin" type="number" placeholder="min" style="width:100px">
        <input id="rankMax" type="number" placeholder="max" style="width:100px">
      </div>
    </div>

    <div class="ctrl">
      <label>Final cost (USD)</label>
      <div style="display:flex; gap:8px">
        <input id="costMin" type="number" placeholder="min $" style="width:110px">
        <input id="costMax" type="number" placeholder="max $" style="width:110px">
      </div>
    </div>

    <div class="ctrl">
      <label>Min GPA</label>
      <div style="display:flex; gap:8px">
        <input id="gpaMin" type="number" step="0.01" placeholder="min" style="width:100px">
        <input id="gpaMax" type="number" step="0.01" placeholder="max" style="width:100px">
      </div>
    </div>

    <div class="ctrl">
      <label>Page size</label>
      <select id="limit">
        <option>20</option>
        <option selected>50</option>
        <option>100</option>
        <option>200</option>
      </select>
    </div>

    <div class="ctrl" style="align-self:end; gap:8px; flex-direction:row">
      <button class="btn primary" id="reload">Neu laden</button>
      <button class="btn" id="reset">Reset Filter</button>
      <button class="btn" id="loadMore">Mehr laden</button>
    </div>

    <div class="badges">
      <span class="badge" id="badgeShown">0 angezeigt</span>
      <span class="badge" id="badgeLoaded">0 geladen</span>
      <span class="badge" id="badgeCursor">cursor: —</span>
    </div>
  </div>

  <div class="export">
    <button class="btn" id="csv">Als CSV exportieren</button>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead><tr id="thead"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
// ----------------- Spalten-Definition -----------------
// title = Überschrift; id = Monday column id; type steuert Darstellung & Sortierung
const COLUMNS = [
  { source:'name', title:'Name', type:'text' },

  // ---- erster Block (aus Screenshot 1) ----
  { id:'dropdown',   title:'State', type:'pill' },
  { id:'dropdown4',  title:'Geographic Area', type:'pill' },
  { id:'text5',      title:'City', type:'text' },
  { id:'location4',  title:'Full Address (Map)', type:'text' },
  { id:'link2',      title:'Virtual Campus Tour?', type:'link' },
  { id:'status8',    title:'Fachabitur?', type:'pill' },
  { id:'long_text68',title:'Fachabitur Details', type:'longtext' },
  { id:'status70',   title:'Realschule?', type:'pill' },
  { id:'long_text72',title:'Realschule Details', type:'longtext' },

  // ---- Ranking-Block ----
  { id:'numbers0',   title:'Ranking (Webometrics)', type:'number' },
  { id:'long_text2', title:'U.S. News Ranking', type:'text' },
  { id:'link5',      title:'U.S. News Link', type:'link' },
  { id:'dropdown2',  title:'Type of Institution', type:'pill' },

  // ---- Enrollment/Ratio ----
  { id:'numbers57',  title:'Total Enrollment (# of students)', type:'number' },
  { id:'numbers_1',  title:'% Enrollment living on Campus', type:'text' },
  { id:'formula5',   title:'Number Students living on Campus', type:'number' },
  { id:'numbers_15', title:'Student-to-Faculty Ratio', type:'number' },

  // ---- Insurance/Fees/Apply ----
  { id:'dropdown7',  title:'University’s Sponsored Insurance Required?', type:'pill' },
  { id:'long_text91',title:'More details Health Insurance', type:'longtext' },
  { id:'long_text23',title:'Application Fee (USD)', type:'text' },
  { id:'long_text73',title:'How to Apply', type:'longtext' },
  { id:'long_text__1',title:'Transfer Pathway Info', type:'longtext' },
  { id:'status96',   title:'Credential Eval Required', type:'pill' },
  { id:'long_text07',title:'+ Info Credential Evaluation', type:'longtext' },

  // ---- Links & Sports ----
  { id:'status14',   title:'Spring Admission?', type:'pill' },
  { id:'status_1',   title:'Spring Scholarships?', type:'pill' },
  { id:'long_text12',title:'Clarification on Add. Information', type:'longtext' },
  { id:'link23',     title:'On Campus Activities', type:'link' },
  { id:'link9',      title:'Sports Homepage', type:'link' },
  { id:'dropdown5',  title:'Athletic Association', type:'pill' },
  { id:'dropdown0',  title:"Men’s Sports", type:'pill' },
  { id:'dup__of_men_sports1', title:"Women’s Sports", type:'pill' },

  // ---- Study Areas / Costs ----
  { id:'link29',     title:'University Homepage', type:'link' },
  { id:'dup__of_university_s_website', title:'International Admission Office', type:'link' },
  { id:'dropdown6',  title:"Bachelor’s Study Areas", type:'pill' },
  { id:'link1',      title:"Bachelor’s Degrees Link", type:'link' },
  { id:'dropdown57', title:'Academic Year', type:'pill' },
  { id:'numbers72',  title:'Tuition (Annual USD)', type:'currency' },
  { id:'numbers_11', title:'Room (Annual USD)', type:'currency' },
  { id:'numbers_24', title:'Board (Annual USD)', type:'currency' },
  { id:'numbers_3',  title:'Required Fees (Annual USD)', type:'currency' },
  { id:'formula27',  title:'TOTAL (Approx Annual USD)', type:'currency' },
  { id:'long_text62',title:'Additional Cost Info', type:'longtext' },

  // ---- Scholarships (lowest/mid/highest) ----
  { id:'dropdown_mkvg9mv3', title:'Admission Requirements', type:'pill' },
  { id:'numbers',   title:'Lowest Scholarship (USD)', type:'currency' },
  { id:'status1',   title:'Competitive vs Guaranteed (Lowest)', type:'pill' },
  { id:'numbers1',  title:'TOEFL min (Lowest)', type:'number' },
  { id:'numbers4',  title:'GPA min (Lowest)', type:'number' },
  { id:'numbers7',  title:'SAT min (Lowest)', type:'number' },
  { id:'long_text', title:'More Info (Lowest)', type:'longtext' },

  { id:'numbers14', title:'Mid-Range Scholarship (USD)', type:'currency' },
  { id:'status68',  title:'Competitive vs Guaranteed (Mid)', type:'pill' },
  { id:'numbers_14',title:'TOEFL min (Mid)', type:'number' },
  { id:'numbers_23',title:'GPA min (Mid)', type:'number' },
  { id:'numbers_39',title:'SAT min (Mid)', type:'number' },
  { id:'long_text06',title:'More Info (Mid)', type:'longtext' },

  { id:'numbers48', title:'Highest Scholarship (USD)', type:'currency' },
  { id:'status6',   title:'Competitive vs Guaranteed (High)', type:'pill' },
  { id:'numbers9',  title:'TOEFL min (High)', type:'number' },
  { id:'numbers43', title:'GPA min (High)', type:'number' },
  { id:'numbers3',  title:'SAT min (High)', type:'number' },
  { id:'long_text4',title:'More Info (High)', type:'longtext' },

  // ---- Net Cost, Deadlines, Work ----
  { id:'formula0',  title:'(Lowest) Possible Net Cost', type:'currency' },
  { id:'formula20', title:'(Mid) Possible Net Cost', type:'currency' },
  { id:'formula52', title:'(Highest) Possible Net Cost', type:'currency' },
  { id:'dropdown_mkvgfq5y', title:'Estimated Annual Cost - Vlookup', type:'pill' },
  { id:'long_text7', title:'Fall Application Deadline', type:'longtext' },
  { id:'long_text1', title:'Spring Application Deadline', type:'longtext' },
  { id:'link',       title:'Deadline Link', type:'link' },
  { id:'long_text6', title:'Add. Requirements Info', type:'longtext' },
  { id:'status3',    title:"Campus Employment Opportunities?", type:'pill' },
  { id:'numbers25',  title:'2025 Minimum Wage', type:'currency' },
  { id:'formula6',   title:'Annual Work on Campus Compensation', type:'currency' },
  { id:'long_text05',title:"Work on Campus Details", type:'longtext' },

  // ---- Meta ----
  { id:'last_updated__1', title:'Last updated', type:'text' },
  { id:'status__1', title:'Partner', type:'pill' },
  { id:'dropdown_mkvtfch4', title:'Estimated Annual Cost', type:'pill' },
];

// --------------- Globals ---------------
let rows = [];           // alle geladenen Items (akkumuliert)
let cursor = null;       // nächster Cursor
let sort = { key: 'name', dir: 'asc' }; // Default

// --------------- UI-Elemente ---------------
const $q = $('#q'), $state = $('#state');
const $rankMin = $('#rankMin'), $rankMax = $('#rankMax');
const $costMin = $('#costMin'), $costMax = $('#costMax');
const $gpaMin  = $('#gpaMin'),  $gpaMax  = $('#gpaMax');
const $limit = $('#limit');

$('#reload').addEventListener('click', reload);
$('#reset').addEventListener('click', resetFilters);
$('#loadMore').addEventListener('click', loadMore);
$('#csv').addEventListener('click', exportCSV);

buildHeader();
reload();   // erste Ladung

// ---------------- kleine Helfer ----------------
function $(sel){ return document.querySelector(sel); }
function el(tag, attrs={}, ...children){
  const n=document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if (k==='class') n.className=v;
    else if (k==='html') n.innerHTML=v;
    else n.setAttribute(k,v);
  });
  children.forEach(c=> n.append(c));
  return n;
}

// ---------------- Lade-Logik ----------------
async function reload(){
  rows=[]; cursor=null;
  await loadMore(true);            // erste Seite
  // States komplett einsammeln (wir holen still im Hintergrund nach und füllen Select)
  collectAllStates();
}
async function loadMore(){
  const params = new URLSearchParams({
    limit: $limit.value,
    cursor: cursor || '',
    q: $q.value,
    state: $state.value,
    rankMin: $rankMin.value,
    rankMax: $rankMax.value,
    costMin: $costMin.value,
    costMax: $costMax.value,
    gpaMin:  $gpaMin.value,
    gpaMax:  $gpaMax.value
  });

  const url = '/.netlify/functions/items?' + params.toString();
  const r = await fetch(url);
  const j = await r.json();

  cursor = j.cursor || null;
  rows = rows.concat(j.items || []);
  updateBadges();
  render();
}
function resetFilters(){
  $q.value=''; $state.value='all';
  $rankMin.value=''; $rankMax.value='';
  $costMin.value=''; $costMax.value='';
  $gpaMin.value='';  $gpaMax.value='';
  reload();
}
function updateBadges(){
  $('#badgeLoaded').textContent = rows.length + ' geladen';
  $('#badgeCursor').textContent = 'cursor: ' + (cursor ? 'more' : '—');
}
function buildHeader(){
  const tr = $('#thead'); tr.innerHTML='';
  COLUMNS.forEach(col=>{
    const th = el('th',{});
    th.textContent = col.title;
    th.addEventListener('click', ()=>{
      sort.key = col.source || col.id || 'name';
      sort.dir = (sort.dir==='asc'?'desc':'asc');
      render();
    });
    tr.append(th);
  });
}

// ---------------- Rendering ----------------
function render(){
  const tbody = $('#tbody'); tbody.innerHTML='';

  // sortierte Kopie
  const sorted = rows.slice().sort((a,b)=>{
    const key = sort.key;
    let av = getCellSortValue(a, key);
    let bv = getCellSortValue(b, key);
    if (typeof av === 'number' && typeof bv === 'number'){
      return sort.dir==='asc' ? (av-bv) : (bv-av);
    }
    av = (av+'').toLowerCase(); bv=(bv+'').toLowerCase();
    return sort.dir==='asc' ? (av>bv?1:av<bv?-1:0) : (av<bv?1:av>bv?-1:0);
  });

  sorted.forEach(row=>{
    const tr = el('tr');
    COLUMNS.forEach(c=>{
      tr.append( renderCell(row, c) );
    });
    tbody.append(tr);
  });
  $('#badgeShown').textContent = sorted.length + ' angezeigt';
}
function getCellSortValue(row, key){
  if (key==='name') return row.name || '';
  const col = (row.cols || []).find(c=> c.id === key);
  if (!col) return '';
  const n = parseFloat((col.text || '').replace(/[, $€£]/g,''));
  return isNaN(n) ? (col.text || '') : n;
}
function renderCell(row, c){
  const td = el('td');
  if (c.source==='name'){ td.textContent = row.name || ''; return td; }

  const col = (row.cols || []).find(k=> k.id === c.id);
  if (!col || (!col.text && !col.value)){
    td.innerHTML = '<span class="empty">—</span>'; return td;
  }

  const text = col.text || '';

  switch (c.type){
    case 'pill': {
      const parts = text.split(',').map(s=>s.trim()).filter(Boolean);
      if (!parts.length){ td.innerHTML='<span class="empty">—</span>'; break; }
      parts.forEach(p=> td.append(el('span',{class:'pill'}, p)));
      break;
    }
    case 'link': {
      // Monday link-value: {"url":"...","text":"..."}
      let url = '';
      try { url = JSON.parse(col.value||'{}').url || ''; } catch(e){}
      if (!url) url = text;
      if (!url){ td.innerHTML='<span class="empty">—</span>'; break; }
      td.append(el('a', { href:url, target:'_blank' }, text||'Link'));
      break;
    }
    case 'currency': {
      const n = parseFloat(text.replace(/[, $€£]/g,''));
      td.textContent = isNaN(n) ? text : new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n);
      td.classList.add('mono');
      break;
    }
    case 'number': {
      const n = parseFloat(text.replace(/,/g,''));
      td.textContent = isNaN(n) ? text : n;
      td.classList.add('mono');
      break;
    }
    case 'longtext': {
      td.textContent = text; break;
    }
    default: {
      td.textContent = text || ''; break;
    }
  }
  return td;
}

// ---- States vollständig nachladen und Dropdown auffüllen
async function collectAllStates(){
  const all = new Set( [...statesFromRows(rows)] );
  let cur = cursor;       // start von aktuellem Cursor
  let guard = 0;
  while(cur && guard++ < 20){     // Schutz: max 20 weitere Seiten
    const params = new URLSearchParams({
      limit: 200, cursor: cur,
      q:'', state:'', rankMin:'', rankMax:'', costMin:'', costMax:'', gpaMin:'', gpaMax:''
    });
    const r = await fetch('/.netlify/functions/items?'+params.toString());
    const j = await r.json();
    (j.items||[]).forEach(it=>{
      statesFromRows([it]).forEach(s => all.add(s));
    });
    cur = j.cursor || null;
  }
  fillStateSelect([...all].sort());
}
function statesFromRows(list){
  const states = new Set();
  list.forEach(row=>{
    const st = row.state && row.state.trim();
    if (st) states.add(st);
  });
  return states;
}
function fillStateSelect(states){
  const cur = $state.value;
  $state.innerHTML = '<option value="all">all</option>';
  states.forEach(s=>{
    const opt = el('option',{value:s}, s);
    $state.append(opt);
  });
  $state.value = cur || 'all';
}

// ---- CSV Export (Excel-kompatibel)
function exportCSV(){
  const cols = COLUMNS;
  let csv = '';
  csv += cols.map(c=> `"${(c.title||'').replace(/"/g,'""')}"`).join(',') + '\n';

  // aktuell gerenderte Reihenfolge übernehmen
  const trs = $('#tbody').querySelectorAll('tr');
  trs.forEach(tr=>{
    const cells = Array.from(tr.children);
    const row = cells.map(td => `"${td.textContent.replace(/"/g,'""')}"`);
    csv += row.join(',') + '\n';
  });

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'bachelors-programs.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
