<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bachelor’s Programs – Freshman & Average Student</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#1f2430; --muted:#6b7280; --line:#eaedf2;
  --primary:#1f76ff; --pill:#eef3ff; --pillText:#1f4fbf; --link:#1f76ff; --thead:#f2f4f8;
  --chip:#f4f6fa; --chipText:#49506a; --stickyW:300px;
}
*{box-sizing:border-box} html,body{height:100%}
body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }
.wrap{max-width:1200px;margin:24px auto;padding:0 20px;}
.h1{font-size:28px;font-weight:700;margin:8px 0 4px;}
.sub{color:var(--muted);font-size:13px;margin-bottom:18px;}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.col{display:flex;flex-direction:column;gap:6px}
.label{font-size:12px;color:var(--muted)}
input,select{height:36px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;color:#1f2430;min-width:120px;}
.nums{width:110px;text-align:right}
.btn{height:36px;padding:0 14px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:8px;}
.btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
.chips{display:flex;gap:8px;align-items:center;font-size:12px}
.chip{background:var(--chip);color:var(--chipText);padding:4px 8px;border-radius:999px}
.muted{color:var(--muted)}
.spacer{flex:1}
.tb-ico{width:18px;height:18px;display:inline-block;vertical-align:-3px}

/* Toolbar */
.toolbar{position:sticky;top:0;z-index:20;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:8px;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.tb-btn{height:30px;padding:0 10px;border:1px solid var(--line);background:#fff;border-radius:8px;font-weight:600;display:inline-flex;align-items:center;gap:8px;cursor:pointer;}
.tb-btn .ico{line-height:1}

/* Popovers */
.popover{position:absolute;top:44px;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,.10);padding:12px;display:none;min-width:340px;}
.popover.open{display:block}
#pvHide{min-width:420px}
#pvFilter{min-width:520px}
#pvSort{min-width:420px}
.pv-row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.pv-row-inline{display:flex;gap:10px;align-items:center}
.pv-actions{display:flex;align-items:center;gap:8px;margin-top:8px}

/* Hide columns popover */
#hideSearch{height:32px;padding:4px 8px;border:1px solid var(--line);border-radius:8px}
.hide-list{max-height:50vh;overflow:auto;margin-top:8px;border-top:1px dashed var(--line);padding-top:6px}
.hide-row{display:flex;align-items:center;gap:10px;padding:6px 2px}
.hide-name{flex:1}
.switch{position:relative;width:34px;height:20px;background:#e5e7eb;border-radius:999px;cursor:pointer;border:1px solid #d1d5db}
.switch::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .18s ease}
.switch.on{background:#22c55e;border-color:#16a34a}
.switch.on::after{left:16px}

/* Compact filter dropdown */
#pvFilter select{ max-width:180px; font-size:13px; height:32px; padding:4px 8px; border-radius:6px; }
#pvFilter input[type="text"]{ height:32px; font-size:13px; padding:4px 8px; }
#pvFilter select:focus,#pvFilter input:focus{ outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(31,118,255,0.2); }

/* Top scrollbar */
.hScrollTop{position:sticky;top:0;z-index:18;background:var(--card);border:1px solid var(--line);border-radius:10px;margin-bottom:8px;height:12px;overflow-x:auto;overflow-y:hidden;}
.hScrollInner{height:1px;}

/* Table */
.tableWrap{background:var(--card);border:1px solid var(--line);border-radius:10px;overflow:auto;position:relative;max-height:70vh;}
table{border-collapse:separate;border-spacing:0;width:max-content;min-width:1200px;}
thead th{position:sticky;top:0;background:var(--thead);z-index:5;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.02em;color:#49506a;padding:8px 12px;min-height:44px;border-bottom:1px solid var(--line);user-select:none;cursor:pointer;box-shadow:0 1px 0 var(--line),0 1px 6px rgba(0,0,0,0.04);text-align:center;}
thead th.sortable::after{content:" ⇅";font-size:10px;color:#999;margin-left:4px;}
thead th.sort-asc::after{content:" ▲";} thead th.sort-desc::after{content:" ▼";}

/* Default center alignment for cells */
tbody td{
  padding:10px 12px; line-height:20px; min-height:44px; border-top:1px solid var(--line);
  vertical-align:middle; font-size:14px; max-width:280px; white-space:nowrap; overflow:hidden;
  text-overflow:ellipsis; text-align:center;
}
/* Long text cells left-aligned */
tbody td.trunc, tbody td.trunc-cell{ text-align:left !important; cursor:pointer; }

th.sticky, td.sticky{position:sticky;left:0;background:#fff;z-index:6;min-width:var(--stickyW);max-width:var(--stickyW);box-shadow:1px 0 0 var(--line);}
thead th.sticky{z-index:7;left:0;}
tbody tr:hover td{background:#f8fafc}

.pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:var(--pill);color:var(--pillText);font-size:12px;line-height:18px;}
.link{color:var(--link);text-decoration:none;font-weight:600}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}

/* Loader container */
#loader{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;font-size:16px;color:#333;z-index:2000;}
.spinner{width:48px;height:48px;border:4px solid #eee;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin-right:12px;}
@keyframes spin{to{transform:rotate(360deg)}}

/* Loader with logo */
#loader .loader-inner{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; }
#loader .loader-logo{ width:140px; height:auto; display:block; opacity:0; animation:fadeIn .6s ease-in forwards; }
#loader .loader-text{ font-size:14px; color:#333; }
@keyframes fadeIn{ to{opacity:1;} }

/* Popup */
#popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px 18px;border:1px solid var(--line);border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,.15);z-index:3000;max-width:700px;max-height:70vh;overflow:auto;}
#popupClose{position:absolute;top:8px;right:12px;cursor:pointer;font-weight:700;}
#popup h4{margin:0 24px 10px 0;font-size:14px;color:#555;}
#popup pre{white-space:pre-wrap;word-break:break-word;font-family:inherit;font-size:14px;margin:0;}
.little-spinner{width:14px;height:14px;border:2px solid #e2e8f0;border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;}

/* Dimension hotfix (wider) */
.wrap{max-width:none;width:min(1800px,98vw);padding:0 12px;}
.hScrollTop,.tableWrap{width:100%;}
@media (min-height:800px){ .tableWrap{max-height:76vh;} }
@media (min-width:1600px){ .wrap{width:min(2000px,96vw);} }

/* Multiple-conditions filter UI */
#condList .cond-row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
#condList .cond-col{ min-width:220px; }
#condList .cond-op{  min-width:170px; }
#condList .cond-val{ min-width:220px; }
#condList .cond-del{ height:30px; }

/* Records badge */
#recordBadge{ display:flex; flex-direction:column; gap:6px; padding:6px 10px;
  background:#fff; border:1px solid var(--line); border-radius:12px; min-width:140px; }
#recordText{ font-size:14px; font-weight:600; color:#1f2937; }
#recordBar{ position:relative; height:8px; background:#d1d5db; border-radius:999px; overflow:hidden; }
#recordBarFill{ height:100%; width:100%; background:#9ca3af; border-radius:999px; transition:width .25s ease; }
</style>
</head>

<body>
<!-- Loader -->
<div id="loader">
  <div class="loader-inner">
    <img src="./Link-zuruck-nach-oben.webp" alt="Epro 360 Logo" class="loader-logo" />
    <div class="spinner"></div>
    <div class="loader-text">Loading data…</div>
  </div>
</div>
<!-- Error banner -->
<div id="errorBanner" style="display:none;margin:10px 0;padding:10px 12px;border:1px solid #f59e0b;background:#fff8e1;border-radius:8px;color:#7c2d12;font-size:13px"></div>

<div class="wrap" id="app" style="display:none">
  <div class="h1">Bachelor’s Programs – Freshman & Average Student</div>
  <div class="sub">The data comes from a secure Netlify function (read-only). The look and feel is inspired by Monday.</div>

  <!-- ======= TOOLBAR ======= -->
  <div class="toolbar" id="toolbar">
    <div class="toolbar-title sr-only">Table actions</div>

    <button class="tb-btn" id="tbHide">
      <svg class="tb-ico" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2"><path d="M3 3l18 18"/><path d="M10.6 10.6a2 2 0 102.8 2.8"/><path d="M9.9 4.2A9.9 9.9 0 0121 12c-.7 1.2-2.5 3.6-5.4 4.9M6.5 6.5C4 8 2.7 9.9 2 12c.7 1.8 2.7 4.5 6 6"/></svg>
      Hide columns
    </button>

    <button class="tb-btn" id="tbFilter">
      <svg class="tb-ico" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2"><path d="M3 5h18l-7 8v6l-4-2v-4z"/></svg>
      Filter
    </button>

    <button class="tb-btn" id="tbGroup">
      <svg class="tb-ico" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2"><rect x="3" y="4" width="8" height="6"/><rect x="13" y="4" width="8" height="6"/><rect x="3" y="14" width="8" height="6"/><rect x="13" y="14" width="8" height="6"/></svg>
      Group
    </button>

    <button class="tb-btn" id="tbSort">
      <svg class="tb-ico" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2"><path d="M7 4v16M7 4l-3 3M7 4l3 3M17 20V4m0 16l-3-3m3 3l3-3"/></svg>
      Sort
    </button>

    <div class="spacer"></div>

    <!-- Records badge -->
    <div id="recordBadge" aria-live="polite">
      <div id="recordText">0 records</div>
      <div id="recordBar"><div id="recordBarFill"></div></div>
    </div>

    <button class="tb-btn" id="tbMore">…</button>

    <!-- HIDE COLUMNS POPOVER -->
    <div class="popover" id="pvHide">
      <div class="pv-row"><label style="font-weight:600">Hide columns</label></div>
      <input id="hideSearch" type="text" placeholder="Find a field" />
      <div class="hide-list" id="hideList"></div>
      <div class="pv-actions">
        <button class="btn" id="hideAllBtn">Hide all</button>
        <div class="spacer"></div>
        <button class="btn" id="showAllBtn">Show all</button>
      </div>
    </div>

    <!-- FILTER POPOVER -->
    <div class="popover" id="pvFilter">
      <div class="pv-row"><label style="font-weight:600">Add conditions</label></div>
      <div id="condList"></div>
      <div class="pv-actions">
        <button class="btn" id="addCondBtn">+ Add condition</button>
        <div class="spacer"></div>
        <button class="btn" id="fltResetBtn">Reset</button>
        <button class="btn primary" id="fltApplyBtn">Apply</button>
      </div>
    </div>

    <!-- SORT POPOVER -->
    <div class="popover" id="pvSort">
      <div class="pv-row"><label style="font-weight:600">Sort by</label></div>
      <div class="pv-row-inline" id="sortRow">
        <select id="sortKey" style="min-width:240px"></select>
        <select id="sortDir" style="min-width:120px">
          <option value="asc">A → Z</option>
          <option value="desc">Z → A</option>
        </select>
      </div>
    </div>

    <!-- MORE POPOVER -->
    <div class="popover" id="pvMore">
      <div class="pv-row-inline">
        <button class="btn" id="reloadBtn"><div class="little-spinner" id="reloadSpin" style="display:none"></div>Reload</button>
        <button class="btn" id="exportBtn">Export Excel</button>
        <button class="btn" id="moreBtn"><div class="little-spinner" id="moreSpin" style="display:none"></div>Load more</button>
      </div>
      <div class="muted" style="margin-top:8px">
        <span id="shown" class="chip">0 shown</span>
        <span id="loaded" class="chip">0 loaded</span>
      </div>
    </div>
  </div>
  <!-- ======= /TOOLBAR ======= -->

  <!-- TOP HORIZONTAL SCROLLBAR -->
  <div class="hScrollTop" id="hScrollTop"><div class="hScrollInner" id="hScrollInner"></div></div>

  <!-- TABLE -->
  <div class="tableWrap" id="tableWrap">
    <table id="tbl">
      <thead><tr id="thead-row"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Popup for full cell text -->
<div id="popup">
  <span id="popupClose">✕</span>
  <h4 id="popupTitle">Details</h4>
  <pre id="popupBody"></pre>
</div>

<script>
(function(){
  // ===== COLUMNS ============================================================
  const COLUMNS = [
    { key:'name',           title:'Name', sticky:true,  sortable:true, type:'text',  colId:'name' },
    { key:'photos_desc',    title:'Photos & Description', type:'link',   colId:'link4' },
    { key:'state',          title:'State',              sortable:true, type:'chip',  colId:'state1', chipCategory:'state' },
    { key:'geo_area',       title:'Geographical Area',  sortable:true, type:'chip',  colId:'dropdown30', chipCategory:'geo' },
    { key:'video_state',    title:'Video I about the State',          type:'link',  colId:'link_14' },
    { key:'city',           title:'City',               trunc:true,    type:'text',  colId:'city' },
    { key:'address',        title:'Full address',       trunc:true,    type:'mono',  colId:'location' },
    { key:'virtual_tour',   title:'Virtual Campus Tour?',             type:'link',  colId:'link_1' },
    { key:'fachabitur',     title:'Fachabitur?',        type:'chip',   colId:'status5', chipCategory:'status' },
    { key:'fach_det',       title:'Fachabitur Details', trunc:true,    type:'text',  colId:'long_text15' },
    { key:'usnews_rank',    title:'U.S. News Ranking',  align:'right', type:'mono',  colId:'long_text' },
    { key:'usnews_link',    title:'U.S. News Link',                   type:'link',  colId:'link1' },
    { key:'type',           title:'Type of Institution',              type:'chip',  colId:'dropdown', chipCategory:'type' },
    { key:'enroll',         title:'Total Enrollment',   align:'right', type:'number',colId:'numbers7' },
    { key:'live_pct',       title:'% Live on Campus',   align:'right', type:'text',  colId:'numbers8' },
    { key:'live_num',       title:'# Live on Campus',   align:'right', type:'number',colId:'formula53' },
    { key:'ratio',          title:'Student-Faculty Ratio',align:'right',type:'number',colId:'numbers81' },
    { key:'insurance',      title:'University Insurance Required?',    trunc:true,  type:'text',  colId:'dropdown8' },
    { key:'insurance_info', title:'More Health Insurance Details',     trunc:true,  type:'text',  colId:'long_text63' },
    { key:'app_fee',        title:'Application Fee',    align:'right', type:'text',  colId:'temporary_university_s_application_fee_cost__usd_' },
    { key:'how_apply',      title:'How to Apply',       trunc:true,    type:'text',  colId:'long_text842' },
    { key:'cred_eval',      title:'Credential Eval Required',          type:'chip',  colId:'status38', chipCategory:'status' },
    { key:'cred_info',      title:'+Info on Credential Evaluation',    trunc:true,  type:'text',  colId:'long_text60' },
    { key:'spring_adm',     title:'Spring Admission?',                 type:'chip',  colId:'status45', chipCategory:'status' },
    { key:'spring_sch',     title:'Spring Scholarships?',              type:'chip',  colId:'status_13', chipCategory:'status' },
    { key:'clarify',        title:'Clarification on Additional Information', trunc:true, type:'text', colId:'long_text9' },
    { key:'campus_acts',    title:'On Campus Activities',              type:'link',  colId:'link2' },
    { key:'sports',         title:'Sports Homepage',                   type:'link',  colId:'link_198' },
    { key:'uni_home',       title:'University Homepage',               type:'link',  colId:'link3' },
    { key:'intl_adm',       title:'International Admission',           type:'link',  colId:'link0' },
    { key:'major',          title:'Bachelor’s Study Areas', sortable:true, trunc:true, type:'text', colId:'dropdown73' },
    { key:'degrees_link',   title:'Bachelor’s Degrees Link',           type:'link',  colId:'link30' },
    { key:'acad_year',      title:'Academic Year',      trunc:true,    type:'text',  colId:'dropdown4' },

    /* Money + formulas (prefer backend-calculated fields) */
    { key:'tuition',        title:'Tuition (Annual Cost in USD)', align:'right', type:'money', colId:'annual_tuition_cost' },
    { key:'room',           title:'Room (Annual Cost in USD)',    align:'right', type:'money', colId:'_usd__annual_room_cost' },
    { key:'board',          title:'Board (Annual Cost in USD)',   align:'right', type:'money', colId:'_usd__annual_board_cost' },
    { key:'fees',           title:'Required Fees (Annual Cost in USD)', align:'right', type:'money', colId:'numbers5' },
    { key:'total',          title:'TOTAL (Approximate Annual Cost in USD)', align:'right', type:'money', colId:'total_calc' },

    { key:'cost_info',      title:'Additional Info and Link/s Annual Cost of Attendance', trunc:true, type:'text', colId:'link_s_annual_cost_of_attendance' },
    { key:'adm_req',        title:'Admission Requirements', trunc:true, type:'text', colId:'_link__requirements_admission_information' },
    { key:'sch_low',        title:'Lowest (USD) Annual Scholarship Amount', align:'right', type:'money', colId:'dup__of_minimum__usd__annual_scholarship_amount6' },
    { key:'sch_low_type',   title:'Competitive vs Guaranteed? (Lowest)', trunc:true, type:'text', colId:'status1' },
    { key:'toefl_low',      title:'TOEFL iBT Minimum (Lowest Scholarship)', align:'right', type:'number', colId:'numbers2' },
    { key:'gpa_low',        title:'GPA Minimum (Lowest Scholarship)', align:'right', type:'number', colId:'numbers34' },
    { key:'sat_low',        title:'SAT Minimum (Lowest Scholarship)', align:'right', type:'number', colId:'numbers0' },
    { key:'sch_low_info',   title:'Additional Info and Link/s on Lowest Scholarship Amount (Lowest)', trunc:true, type:'text', colId:'additional_info_and_link_s_on_minimum_scholarship_amount' },
    { key:'sch_mid',        title:'Mid-Range (USD) Annual Scholarship Amount (Mid-Range Scholarship)', align:'right', type:'money', colId:'numbers68' },
    { key:'sch_mid_type',   title:'Competitive vs Guaranteed? (Mid-Range Scholarship)', trunc:true, type:'text', colId:'status_132' },
    { key:'toefl_mid',      title:'TOEFL iBT Minimum (Most Probable Scholarship)', align:'right', type:'number', colId:'numbers54' },
    { key:'gpa_mid',        title:'GPA Minimum (Most Probable Scholarship)', align:'right', type:'number', colId:'numbers64' },
    { key:'sat_mid',        title:'SAT Minimum (Most Probable Scholarship)', align:'right', type:'number', colId:'numbers414' },
    { key:'sch_mid_info',   title:'Additional Info and Link/s on Mid-Range Scholarship Amount (F) (Mid-Range Scholarship)', trunc:true, type:'text', colId:'long_text31' },
    { key:'sch_hi',         title:'Highest (USD) Annual Scholarship Amount', align:'right', type:'money', colId:'numbers11' },
    { key:'sch_hi_type',    title:'High: Type', trunc:true, type:'text', colId:'dup__of_competitive_vs_guaranteed___gpa__3_5__highest_' },
    { key:'toefl_hi',       title:'TOEFL iBT Minimum (Highest Scholarship)', align:'right', type:'number', colId:'numbers70' },
    { key:'gpa_hi',         title:'GPA Minimum (Highest Scholarship)', align:'right', type:'number', colId:'numbers4' },
    { key:'sat_hi',         title:'SAT Minimum (Highest Scholarship)', align:'right', type:'number', colId:'numbers41' },
    { key:'sch_hi_info',    title:'Additional Info and Link/s on Highest Scholarship Amount (Highest)', trunc:true, type:'text', colId:'long_text78' },

    /* Net costs — backend ids */
    { key:'net_low',        title:'(Lowest) Possible Net Cost of Attendance', align:'right', type:'money', colId:'net_low_calc' },
    { key:'net_mid',        title:'(Mid-Range) Possible Net Cost of Attendance (F)', align:'right', type:'money', colId:'net_mid_calc' },
    { key:'net_hi',         title:'(Highest) Possible Net Cost of Attendance', align:'right', type:'money', colId:'net_hi_calc' },

    { key:'dead_fall',      title:'Fall Application Deadline', trunc:true, type:'text', colId:'deadline_fall_application' },
    { key:'dead_spring',    title:'Spring Application Deadline', trunc:true, type:'text', colId:'deadline_spring_application' },
    { key:'dead_link',      title:'Deadline Link', type:'link', colId:'link_104' },
    { key:'campus_job',     title:'Campus Employment?', type:'chip', colId:'status_113', chipCategory:'status' },
    { key:'min_wage',       title:'2025 Min Wage', align:'right', type:'money', colId:'numbers985' },

    /* Work comp — backend calc */
    { key:'work_comp',      title:'Annual Work on Campus Compensation (Most Probable)', align:'right', type:'money', colId:'work_comp_calc' },
    { key:'work_details_b', title:'Work on Campus Details', trunc:true, type:'text', colId:'long_text56' },
  ];

  // show ALL columns in filter pickers
  const DEFAULT_FILTERABLE_KEYS = COLUMNS.map(c=>c.key);

  // --- global error surface
  window.addEventListener('error', function (e) {
    const b = document.getElementById('errorBanner');
    if (b) { b.textContent = 'Script error: ' + (e && e.message ? e.message : 'Unknown'); b.style.display = 'block'; }
    const l = document.getElementById('loader'); if (l) l.style.display = 'none';
    const app = document.getElementById('app'); if (app) app.style.display = 'block';
  });
  window.addEventListener('unhandledrejection', function (e) {
    const b = document.getElementById('errorBanner');
    const msg = e && e.reason ? (e.reason.message || String(e.reason)) : 'Unknown promise rejection';
    if (b) { b.textContent = 'Runtime error: ' + msg; b.style.display = 'block'; }
    const l = document.getElementById('loader'); if (l) l.style.display = 'none';
    const app = document.getElementById('app'); if (app) app.style.display = 'block';
  });

  // --------- UI refs
  const app = document.getElementById('app');
  const loader = document.getElementById('loader');
  const tbody = document.getElementById('tbody');
  const theadRow = document.getElementById('thead-row');
  const shown = document.getElementById('shown');
  const loaded = document.getElementById('loaded');
  const recordText = document.getElementById('recordText');
  const recordBarFill = document.getElementById('recordBarFill');

  // Top scrollbar & table wrap
  const hScrollTop = document.getElementById('hScrollTop');
  const hScrollInner = document.getElementById('hScrollInner');
  const tableWrap = document.getElementById('tableWrap');
  const tbl = document.getElementById('tbl');

  // Buttons
  const reloadBtn = document.getElementById('reloadBtn');
  const reloadSpin = document.getElementById('reloadSpin');
  const moreBtn = document.getElementById('moreBtn');
  const moreSpin = document.getElementById('moreSpin');
  const exportBtn = document.getElementById('exportBtn');

  // Popovers + toolbar buttons
  const tbHide = document.getElementById('tbHide');
  const tbFilter = document.getElementById('tbFilter');
  const tbSort = document.getElementById('tbSort');

  const pvHide = document.getElementById('pvHide');
  const pvFilter = document.getElementById('pvFilter');
  const pvSort = document.getElementById('pvSort');

  // Hide columns refs
  const hideSearch = document.getElementById('hideSearch');
  const hideList = document.getElementById('hideList');
  const hideAllBtn = document.getElementById('hideAllBtn');
  const showAllBtn = document.getElementById('showAllBtn');

  // Filter (multi-rule)
  const fltApplyBtn = document.getElementById('fltApplyBtn');
  const fltResetBtn = document.getElementById('fltResetBtn');
  const addCondBtn  = document.getElementById('addCondBtn');
  const condList    = document.getElementById('condList');
  let rules = []; // { col, op, val }

  // Sort
  const sortKeySel = document.getElementById('sortKey');
  const sortDirSel = document.getElementById('sortDir');
  let sort = { key:null, dir:1 };

  // Hidden columns set
  const hidden = new Set();

  // Popup
  const popup = document.getElementById('popup');
  const popupTitle = document.getElementById('popupTitle');
  const popupBody = document.getElementById('popupBody');
  const popupClose = document.getElementById('popupClose');
  popupClose.onclick = () => popup.style.display = 'none';
  function openPopup(title, text){ popupTitle.textContent = title || 'Details'; popupBody.textContent = text || ''; popup.style.display = 'block'; }

  // --------- Color chip helpers
  function chipHTML(text, bg, border, fg){ if (!text) return ''; return '<span class="pill" style="background:'+bg+';border:1px solid '+border+';color:'+fg+';padding:4px 10px">'+esc(text)+'</span>'; }
  const GEO_STYLES = {'Pacific West Coast':['#FFF4DB','#FFDFA6','#915930'],'West':['#FFE8EE','#FFC6D4','#8A2E45'],'Midwest':['#E7F7FF','#C8EFFF','#0B5586'],'Southeast':['#EFFFF3','#CCF3D7','#1F6B3A'],'Northeast':['#F1ECFF','#DDD6FE','#4A38A5'],'Southwest':['#FFF0E6','#FFD6BD','#884A1F']};
  const STATUS_STYLES = {'shareable':['#E6F6EA','#BFE7C8','#256D3C'],'working on it':['#E6F0FF','#C9D7FF','#2746B3'],'in progress':['#E6F0FF','#C9D7FF','#2746B3'],'yes':['#E6F6EA','#BFE7C8','#256D3C'],'true':['#E6F6EA','#BFE7C8','#256D3C'],'no':['#FEEAEA','#F8C7C7','#9F1D1D'],'not shareable':['#FEEAEA','#F8C7C7','#9F1D1D'],'false':['#FEEAEA','#F8C7C7','#9F1D1D'],'unknown':['#F2F4F7','#E4E7EC','#475467'],'n/a':['#F2F4F7','#E4E7EC','#475467'],'':['#F2F4F7','#E4E7EC','#475467']};
  const TYPE_STYLES = {'Public':['#E7F7FF','#C8EFFF','#0B5586'],'Private':['#FFE8EE','#FFC6D4','#8A2E45'],'Community College':['#FFF4DB','#FFDFA6','#915930']};
  const STATE_HUES = [['#E6F6EA','#BFE7C8','#256D3C'],['#E6F0FF','#C9D7FF','#2746B3'],['#FFF4DB','#FFDFA6','#915930'],['#F1ECFF','#DDD6FE','#4A38A5'],['#E7F7FF','#C8EFFF','#0B5586'],['#FFE8EE','#FFC6D4','#8A2E45'],['#EFFFF3','#CCF3D7','#1F6B3A'],['#FFF0E6','#FFD6BD','#884A1F'],['#F2F4F7','#E4E7EC','#475467'],['#EAF3FF','#CFE2FF','#23498C'],['#FDEBF6','#F8CDE8','#8F2D6A'],['#EAFBF7','#CFF3EA','#176D63']];
  function hashIndex(str){ let h=0; str=String(str||''); for(let i=0;i<str.length;i++){ h=(h*31 + str.charCodeAt(i))|0; } if(h<0) h=-h; return h % STATE_HUES.length; }
  function chipsFor(val, category){
    if (!val) return '';
    const parts = String(val).split(',').map(s=>s.trim()).filter(Boolean);
    let out = '';
    for (const p of parts){
      let bg='#F4F6FA', bd='#E6E9F0', fg='#49506A';
      if (category==='geo' && GEO_STYLES[p]) [bg,bd,fg]=GEO_STYLES[p];
      else if (category==='status'){ const st=STATUS_STYLES[(p||'').toLowerCase()] || STATUS_STYLES['unknown']; [bg,bd,fg]=st; }
      else if (category==='type' && TYPE_STYLES[p]) [bg,bd,fg]=TYPE_STYLES[p];
      else if (category==='state'){ const h=STATE_HUES[hashIndex(p)]; [bg,bd,fg]=h; }
      out += chipHTML(p, bg, bd, fg) + ' ';
    }
    return out.trim();
  }

  // --------- Helpers
  function safeReplaceAll(str, search, repl){ return String(str).split(search).join(repl); }
  function readCell(item, colId){
    const cvs = item && item.column_values ? item.column_values : null; if (!cvs) return "";
    const v = cvs.find(c=>c.id===colId); if (!v) return "";
    const t = v.type;
    if (t === "text" || t === "long-text") return v.text || "";
    if (t === "dropdown") return safeReplaceAll(v.text || "", ";", ", ");
    if (t === "status") return v.text || "";
    if (t === "numbers") return v.text || v.value || "";
    if (t === "link") return v.text || v.url || "";
    if (t === "location") return v.text || "";
    if (t === "formula") return v.text || "";
    return v.text || "";
  }
  function numberFrom(a){ if(a==null) return null; const s = (""+a).replace(/[^\d.\-]/g,''); if(!s) return null; const n = parseFloat(s); return Number.isFinite(n)?n:null; }
  function formatMoney(n){ if(n==null || n==="") return ""; try{ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n); } catch{ return "$"+n; } }
  function formatInt(n){ if(n==null || n==="") return ""; try{ return new Intl.NumberFormat('en-US',{maximumFractionDigits:0}).format(n); } catch{ return String(n); } }
  function esc(s){ return (s==null?"":String(s)).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // --------- Dynamic columns (respect hidden set)
  function visibleCols(){ return COLUMNS.filter(c => !hidden.has(c.key)); }
  function buildThead(){
    const cols = visibleCols();
    theadRow.innerHTML = cols.map(col=>{
      const cls = [
        col.sticky ? 'sticky':'',
        col.sortable ? 'sortable':'',
        col.align==='right' ? 'right':''
      ].filter(Boolean).join(' ');
      return `<th class="${cls}" data-key="${esc(col.key)}">${esc(col.title)}</th>`;
    }).join('');
  }

  // --------- Filter (multi-rule) UI
  function columnOptionsHTML(selectedKey){
    return ['<option value="">Select a column…</option>']
      .concat(COLUMNS.map(c => `<option value="${esc(c.key)}"${c.key===selectedKey?' selected':''}>${esc(c.title)}</option>`))
      .join('');
  }
  function operatorOptionsHTML(selectedOp){
    const ops = [['contains','contains…'],['notcontains','does not contain…'],['is','is…'],['isnot','is not…'],['starts','starts with…'],['ends','ends with…'],['empty','is empty'],['notempty','is not empty']];
    return ops.map(([v,l])=>`<option value="${v}"${v===selectedOp?' selected':''}>${l}</option>`).join('');
  }
  function rowHTML(rule, idx){
    const valInput = (rule.op==='empty' || rule.op==='notempty')
      ? `<input class="cond-val" type="text" value="" disabled />`
      : `<input class="cond-val" type="text" value="${esc(rule.val||'')}" placeholder="value…" />`;
    return `
      <div class="cond-row" data-idx="${idx}">
        <select class="cond-col">${columnOptionsHTML(rule.col)}</select>
        <select class="cond-op">${operatorOptionsHTML(rule.op||'contains')}</select>
        ${valInput}
        <button type="button" class="btn cond-del" title="Remove">🗑️</button>
      </div>
    `;
  }
  function rebuildConditionsUI(){
    condList.innerHTML = rules.map(rowHTML).join('');
    condList.querySelectorAll('.cond-row').forEach(rowEl=>{
      const idx = +rowEl.getAttribute('data-idx');
      const colSel = rowEl.querySelector('.cond-col');
      const opSel  = rowEl.querySelector('.cond-op');
      const valInp = rowEl.querySelector('.cond-val');
      const delBtn = rowEl.querySelector('.cond-del');

      colSel.addEventListener('change', e=>{ rules[idx].col = e.target.value || ''; });
      opSel.addEventListener('change', e=>{
        rules[idx].op = e.target.value || 'contains';
        const needsVal = !(rules[idx].op==='empty' || rules[idx].op==='notempty');
        if (valInp){ valInp.disabled = !needsVal; if (!needsVal) valInp.value = ''; rules[idx].val = needsVal ? (valInp.value||'') : ''; }
      });
      if (valInp){ valInp.addEventListener('input', e=>{ rules[idx].val = e.target.value || ''; }); }
      delBtn.addEventListener('click', ()=>{ rules.splice(idx,1); rebuildConditionsUI(); });
    });
  }
  function addRule(){ rules.push({ col:'', op:'contains', val:'' }); rebuildConditionsUI(); }
  if (addCondBtn) addCondBtn.addEventListener('click', addRule);

  // Filter popover toggle
  if (tbFilter && pvFilter){
    tbFilter.addEventListener('click', (e)=>{
      e.stopPropagation();
      pvFilter.classList.toggle('open');
      if (pvFilter.classList.contains('open')){
        if (rules.length===0) addRule();
        const r = tbFilter.getBoundingClientRect();
        pvFilter.style.left = (r.left) + 'px';
        pvFilter.style.top  = (r.bottom + window.scrollY + 8) + 'px';
        const firstSel = condList.querySelector('.cond-row .cond-col');
        if (firstSel) setTimeout(()=>firstSel.focus(), 0);
      }
    });
  }
  document.addEventListener('click', (e)=>{
    if (!pvFilter.contains(e.target) && e.target !== tbFilter) pvFilter.classList.remove('open');
    if (!pvHide.contains(e.target) && e.target !== tbHide) pvHide.classList.remove('open');
    if (!pvSort.contains(e.target) && e.target !== tbSort) pvSort.classList.remove('open');
  });
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape'){ pvFilter.classList.remove('open'); pvHide.classList.remove('open'); pvSort.classList.remove('open'); }
  });

  if (fltApplyBtn){ fltApplyBtn.addEventListener('click', ()=>{ pvFilter.classList.remove('open'); render(); }); }
  if (fltResetBtn){ fltResetBtn.addEventListener('click', ()=>{ rules = []; rebuildConditionsUI(); pvFilter.classList.remove('open'); render(); }); }

  // --------- Hide columns UI
  function drawHideList(){
    const q = (hideSearch.value||'').toLowerCase();
    const rows = COLUMNS
      .filter(c => c.key!=='name') // keep Name always visible
      .filter(c => c.title.toLowerCase().includes(q) || c.key.toLowerCase().includes(q))
      .map(c=>{
        const on = !hidden.has(c.key);
        return `
          <div class="hide-row" data-key="${esc(c.key)}">
            <div class="switch ${on?'on':''}" aria-label="toggle ${esc(c.title)}" role="switch" aria-checked="${on?'true':'false'}"></div>
            <div class="hide-name">${esc(c.title)}</div>
          </div>
        `;
      }).join('');
    hideList.innerHTML = rows || '<div class="muted" style="padding:6px 2px">No matches</div>';

    hideList.querySelectorAll('.hide-row .switch').forEach(sw=>{
      sw.addEventListener('click', ()=>{
        const key = sw.parentElement.getAttribute('data-key');
        if (hidden.has(key)) hidden.delete(key); else hidden.add(key);
        sw.classList.toggle('on');
        sw.setAttribute('aria-checked', sw.classList.contains('on')?'true':'false');
        buildThead(); attachSortHandlers(); render();
      });
    });
  }
  if (tbHide){
    tbHide.addEventListener('click', (e)=>{
      e.stopPropagation();
      pvHide.classList.toggle('open');
      if (pvHide.classList.contains('open')){
        const r = tbHide.getBoundingClientRect();
        pvHide.style.left = (r.left) + 'px';
        pvHide.style.top  = (r.bottom + window.scrollY + 8) + 'px';
        drawHideList();
        hideSearch.focus();
      }
    });
  }
  hideSearch.addEventListener('input', drawHideList);
  hideAllBtn.addEventListener('click', ()=>{ COLUMNS.forEach(c=>{ if(c.key!=='name') hidden.add(c.key); }); drawHideList(); buildThead(); attachSortHandlers(); render(); });
  showAllBtn.addEventListener('click', ()=>{ hidden.clear(); drawHideList(); buildThead(); attachSortHandlers(); render(); });

  // --------- Sort (A→Z / Z→A) UI
  function initSortUI(){
    sortKeySel.innerHTML = ['<option value="">Name</option>']
      .concat(COLUMNS.filter(c=>c.sortable || c.type==='text' || c.type==='money' || c.type==='number')
        .map(c=>`<option value="${esc(c.key)}">${esc(c.title)}</option>`)).join('');
    sortKeySel.addEventListener('change', e=>{ const k=e.target.value||'name'; sort.key=k; render(); });
    sortDirSel.addEventListener('change', e=>{ sort.dir = (e.target.value==='asc')?1:-1; render(); });
  }
  if (tbSort){
    tbSort.addEventListener('click', (e)=>{
      e.stopPropagation();
      pvSort.classList.toggle('open');
      if (pvSort.classList.contains('open')){
        const r = tbSort.getBoundingClientRect();
        pvSort.style.left = (r.left) + 'px';
        pvSort.style.top  = (r.bottom + window.scrollY + 8) + 'px';
        if (!sort.key) sort.key = 'name';
        initSortUI();
        sortKeySel.value = sort.key || '';
        sortDirSel.value = sort.dir===1 ? 'asc' : 'desc';
      }
    });
  }

  function applySort(arr){
    if(!sort.key) return;
    const meta = COLUMNS.find(c=>c.key===sort.key) || COLUMNS.find(c=>c.key==='name');
    const d = sort.dir;
    const type = meta && (meta.type==='money' || meta.type==='number') ? 'number':'text';
    arr.sort((a,b)=>{
      let va = a[sort.key], vb = b[sort.key];
      if (type==='number'){
        const na = numberFrom(va), nb = numberFrom(vb);
        if(na!=null && nb!=null) return (na-nb)*d;
      }
      return String(va||'').localeCompare(String(vb||''))*d;
    });
  }
  function updateSortIndicators(){
    document.querySelectorAll('thead th').forEach(th=>{
      th.classList.remove('sort-asc','sort-desc');
      const key = th.getAttribute('data-key');
      if(key && key === sort.key) th.classList.add(sort.dir===1?'sort-asc':'sort-desc');
    });
  }
  function attachSortHandlers(){
    document.querySelectorAll('thead th').forEach(th=>{
      const key = th.getAttribute('data-key');
      if (COLUMNS.find(c=>c.key===key)){
        th.addEventListener('click', ()=>{
          if (sort.key===key) sort.dir*=-1; else { sort.key=key; sort.dir=1; }
          sortKeySel && (sortKeySel.value = sort.key);
          sortDirSel && (sortDirSel.value = sort.dir===1?'asc':'desc');
          render();
        });
      }
    });
  }

  // --------- Map item -> row object
  function itemToRow(item){
    const row = {};
    for (const col of COLUMNS){
      if (hidden.has(col.key)) continue; // we'll still compute but render filters use only visible; optional choice
      let raw;
      if (col.key==='name') {
        raw = (item && item.name ? item.name : '');
      } else if (Object.prototype.hasOwnProperty.call(item, col.colId)) {
        raw = item[col.colId]; // backend-calculated field support
      } else {
        raw = readCell(item, col.colId);
      }
      if (col.type==='number' || col.type==='money') raw = numberFrom(raw);
      row[col.key] = raw;
    }
    return row;
  }

  // --------- Cell renderer
  function renderCell(col, val){
    const title = col.title;
    if (col.type==='link')       return truncCell(val, title);
    if (col.type==='mono')       return `<span class="trunc mono" data-title="${esc(title)}" data-full="${esc(val||'')}">${esc(val||'')}</span>`;
    if (col.type==='chip')       return chipsFor(val, col.chipCategory);
    if (col.type==='money')      return (val==null? '' : formatMoney(val));
    if (col.type==='number')     return (val==null? '' : formatInt(val));
    if (col.trunc===true)        return `<span class="trunc" data-title="${esc(title)}" data-full="${esc(val||'')}">${esc(val||'')}</span>`;
    return esc(val||'');
  }
  function truncCell(content, title){
    const full = (content==null?"":String(content)).trim(); if(!full) return '';
    const urlMatch = full.match(/https?:\/\/\S+/); if(urlMatch) return '<a class="link" href="'+esc(urlMatch[0])+'" target="_blank" rel="noopener">Link</a>';
    return '<span class="trunc" data-title="'+esc(title||'Details')+'" data-full="'+esc(full)+'">'+esc(full)+'</span>';
  }

  // --------- Data & state
  let items = [];
  let cursor = null;
  let isLoading = false;

  // --------- Filtering logic (multi-rule, AND)
  function passesAll(row){
    if (!rules || !rules.length) return true;
    for (const r of rules){
      const key = (r.col||'').trim(); if (!key) return true;
      const cell = row[key];
      const s = (cell==null ? '' : String(cell)).toLowerCase();
      const v = String(r.val || '').toLowerCase();
      switch (r.op){
        case 'contains':     if (!v || s.indexOf(v) !== -1) break; else return false;
        case 'notcontains':  if (!v || s.indexOf(v) === -1) break; else return false;
        case 'is':           if (s === v) break; else return false;
        case 'isnot':        if (s !== v) break; else return false;
        case 'starts':       if (!v || s.lastIndexOf(v, 0) === 0) break; else return false;
        case 'ends':         if (!v || s.slice(-v.length) === v) break; else return false;
        case 'empty':        if (s.trim() === '') break; else return false;
        case 'notempty':     if (s.trim() !== '') break; else return false;
        default:             break;
      }
    }
    return true;
  }

  // --------- Render table
  function render(){
    const rows = items.map(itemToRow);

    // Apply filters
    const filtered = rows.filter(passesAll);

    // Update counters
    if (recordText) recordText.textContent = `${filtered.length} records`;
    if (shown) shown.textContent = filtered.length + ' shown';
    if (loaded) loaded.textContent = items.length + ' loaded';

    // Sort + draw
    applySort(filtered);
    updateSortIndicators();

    const cols = visibleCols();
    let html = '';
    for (const r of filtered){
      html += '<tr>';
      for (const col of cols){
        const val = r[col.key];
        const cls = [
          col.sticky ? 'sticky':'',
          col.align==='right' ? 'right':'',
          col.trunc ? 'trunc-cell':''
        ].filter(Boolean).join(' ');
        const tdClass = cls ? ` class="${cls}"` : '';
        html += `<td${tdClass}>${renderCell(col, val)}</td>`;
      }
      html += '</tr>';
    }
    tbody.innerHTML = html;

    const hasCursor = !!cursor;
    if (moreBtn) moreBtn.style.display = hasCursor ? 'inline-flex' : 'none';

    adjustTableHeight();
    syncTopScrollbar();
  }

  // --------- Head actions & popover wiring for More
  const tbMore = document.getElementById('tbMore');
  const pvMore = document.getElementById('pvMore');
  if (tbMore && pvMore){
    tbMore.addEventListener('click', (e)=>{
      e.stopPropagation();
      pvMore.classList.toggle('open');
      if (pvMore.classList.contains('open')){
        const r = tbMore.getBoundingClientRect();
        pvMore.style.left = (r.left) + 'px';
        pvMore.style.top  = (r.bottom + window.scrollY + 8) + 'px';
      }
    });
  }

  // Delegated click for popup (for .trunc spans)
  document.getElementById('tbody').addEventListener('click', (e)=>{
    let target = e.target;
    while (target && target !== tbody && !target.classList.contains('trunc')) target = target.parentNode;
    if(!target || target === tbody) return;
    const title = target.getAttribute('data-title') || 'Details';
    const full = target.getAttribute('data-full') || target.textContent || '';
    if (String(full).trim()) openPopup(title, full);
  });

  // Controls
  if (reloadBtn) reloadBtn.onclick = ()=>{ if(isLoading) return; initialLoad(); };
  if (moreBtn) moreBtn.onclick = ()=>{
    if(isLoading || !cursor) return;
    fetchAndAppend({limit: 100, cursorParam: cursor, progressive: true});
  };

  // Excel export (uses dynamic headers)
  if (exportBtn) exportBtn.addEventListener('click', function(){
    const headers = visibleCols().map(c=>c.title);
    const rows = Array.from(tbody.querySelectorAll('tr')).map(tr =>
      Array.from(tr.children).map(td => td.textContent.replace(/\s+/g,' ').trim())
    );
    const aoa = [headers, ...rows];
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Programs');
    XLSX.writeFile(wb, 'bachelors-programs.xlsx');
  });

  // Scroll sync
  let syncingTop = false, syncingBottom = false;
  function syncTopScrollbar(){
    if (!tbl || !hScrollInner || !hScrollTop || !tableWrap) return;
    const w = tbl.scrollWidth;
    hScrollInner.style.width = w + 'px';
    hScrollTop.scrollLeft = tableWrap.scrollLeft;
  }
  if (hScrollTop) hScrollTop.addEventListener('scroll', function(){
    if(syncingTop) return; syncingBottom = true;
    if (tableWrap) tableWrap.scrollLeft = hScrollTop.scrollLeft;
    syncingBottom = false;
  });
  if (tableWrap) tableWrap.addEventListener('scroll', function(){
    if(syncingBottom) return; syncingTop = true;
    if (hScrollTop) hScrollTop.scrollLeft = tableWrap.scrollLeft;
    syncingTop = false;
  });
  function adjustTableHeight(){
    if (!tableWrap) return;
    const vwTop = tableWrap.getBoundingClientRect().top;
    const maxH = Math.max(360, window.innerHeight - vwTop - 16);
    tableWrap.style.maxHeight = maxH + 'px';
  }
  window.addEventListener('resize', function(){ syncTopScrollbar(); adjustTableHeight(); });

  // Data fetching
  async function fetchBatch(params){
    const errorBanner = document.getElementById('errorBanner');
    const base = location.origin || window.location.href;
    const url = new URL('/.netlify/functions/items', base);
    url.searchParams.set('limit', String(params && params.limit ? params.limit : '100'));
    if (params && params.cursorParam) url.searchParams.set('cursor', params.cursorParam);
    try {
      const resp = await fetch(url.toString(), { cache: 'no-store' });
      if (!resp.ok) {
        let txt=''; try{ txt = await resp.text(); }catch(_){}
        throw new Error('HTTP '+resp.status+': '+String(txt).slice(0,300));
      }
      const json = await resp.json();
      if (!json || !Array.isArray(json.items)) throw new Error('Unexpected payload: '+JSON.stringify(json).slice(0,300));
      errorBanner && (errorBanner.style.display = 'none');
      return json;
    } catch (e) {
      console.error('Fetch failed', e);
      if (errorBanner) { errorBanner.textContent = 'Could not load data. ' + (e && e.message ? e.message : String(e)); errorBanner.style.display = 'block'; }
      return { items: [], cursor: null };
    }
  }
  async function fetchAndAppend(opts){
    setMoreLoading(true);
    const res = await fetchBatch(opts || {});
    const batch = res.items || [];
    const cur = res.cursor || null;
    if (batch.length){
      items.push(...batch);
      render();
    }
    cursor = cur;

    while (opts && opts.progressive && cursor){
      const resN = await fetchBatch({limit:100, cursorParam: cursor});
      const nextBatch = resN.items || [];
      const nextCur = resN.cursor || null;
      if (nextBatch.length){
        items.push(...nextBatch);
        render();
      }
      cursor = nextCur;
    }
    setMoreLoading(false);
  }
  function showLoader(on){ if (loader) loader.style.display = on ? 'flex' : 'none'; }
  function setMoreLoading(on){
    isLoading = on;
    if (moreBtn) moreBtn.disabled = on;
    if (reloadBtn) reloadBtn.disabled = on;
    if (moreSpin) moreSpin.style.display = on ? 'inline-block' : 'none';
    if (reloadSpin) reloadSpin.style.display = on ? 'inline-block' : 'none';
    const span = moreBtn ? moreBtn.querySelector('span') : null;
    if (span) span.textContent = on ? 'Load more…' : 'Load more';
    if (recordBarFill) recordBarFill.style.width = on ? '40%' : '100%';
  }

  // --------- Init
  function initialHeadersAndUI(){
    buildThead();
    attachSortHandlers();
    initSortUI();
    // Default sort by Name asc
    sort = { key:'name', dir:1 };
    sortKeySel && (sortKeySel.value = 'name');
    sortDirSel && (sortDirSel.value = 'asc');

    // Wire popovers already done
  }

  async function initialLoad(){
    items = []; cursor = null;
    showLoader(true);
    try { await fetchAndAppend({limit:100, cursorParam:null, progressive:false}); }
    finally {
      showLoader(false);
      if (app) app.style.display = 'block';
      syncTopScrollbar();
      adjustTableHeight();
    }
    if (cursor) { fetchAndAppend({limit:100, cursorParam:cursor, progressive:true}); }
  }

  // start
  initialHeadersAndUI();
  initialLoad();
})();
</script>
</body>
</html>
