<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bachelor‚Äôs Programs ‚Äì Freshman Student</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

<style>
:root{
  --bg:var(--brand-cyan-20); /* brand-cyan background */
  --card:#ffffff;
  --text:#1f2430;
  --muted:#6b7280;
  --line:#eaedf2;

  /* Needed for .chip styles */
  --chip:#f4f6fa;
  --chipText:#49506a;

  /* Epro 360 brand colors */
  --brand-cyan:#00B5C8;
  --brand-coral:#EE4A4F;
  --brand-ink:#33312E;
  --brand-cyan-10:#F0FBFC;
  --brand-cyan-20:#E3F7FA;

  /* Updated theme variables mapped to brand */
  --primary:var(--brand-cyan);
  --pill:var(--brand-cyan-10);
  --pillText:var(--brand-ink);
  --link:#1f76ff;              /* restore original link blue */
  --thead:#fff;                /* table header background = white */

  --stickyW:300px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  /* NEW: keep page from scrolling; scroll happens inside .tableWrap */
  overflow:hidden;
}
.wrap{max-width:1200px;margin:24px auto;padding:0 20px;}
.h1{font-size:28px;font-weight:700;margin:8px 0 4px;}
.sub{color:var(--muted);font-size:13px;margin-bottom:18px;}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.col{display:flex;flex-direction:column;gap:6px}
.label{font-size:12px;color:var(--muted)}
input,select{
  height:36px;
  padding:0 10px;
  border:1px solid var(--line);
  border-radius:8px;
  background:#fff;
  color:#1f2430;
  min-width:120px;
}
.nums{width:110px;text-align:right}
.btn{
  height:36px;
  padding:0 14px;
  border-radius:8px;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
  font-weight:600;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.btn.primary{
  background:var(--primary);
  border-color:var(--primary);
  color:#fff;
}
.chips{display:flex;gap:8px;align-items:center;font-size:12px}
.chip{
  background:var(--chip);
  color:var(--chipText);
  padding:4px 8px;
  border-radius:999px;
}
.muted{color:var(--muted)}
.spacer{flex:1}
.tb-ico{width:18px;height:18px;display:inline-block;vertical-align:-3px}

/* Toolbar (now INSIDE .tableWrap) */
.toolbar{
  position:sticky;
  top:0;
  z-index:20;
  background:#fff;
  /* NEW: no outer border here; the tableWrap provides the cyan frame */
  border:0;
  border-bottom:1px solid var(--line);
  border-radius:12px 12px 0 0;
  padding:8px;
  margin:0;
  display:flex;
  align-items:center;
  gap:8px;
}

/* Toolbar buttons */
.tb-btn{
  height:30px;
  padding:0 10px;
  border:1px solid var(--line);
  background:#fff;
  border-radius:8px;
  font-weight:600;
  display:inline-flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
}
.tb-btn .ico{line-height:1}

/* Popovers */
.popover{
  position:absolute;
  top:44px;
  background:#fff;
  border:1px solid var(--line);
  border-radius:10px;
  box-shadow:0 12px 30px rgba(0,0,0,.10);
  padding:12px;
  display:none;
  min-width:340px;
  z-index:50;
}
.popover.open{display:block}
#pvHide{min-width:420px}
#pvFilter{min-width:520px}
#pvSort{min-width:420px}
.pv-row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.pv-row-inline{display:flex;gap:10px;align-items:center}
.pv-actions{display:flex;align-items:center;gap:8px;margin-top:8px}

/* Table wrapper ‚Äî white background + cyan border; owns scrolling */
.tableWrap{
  background:#fff;
  border:2px solid var(--brand-cyan);
  border-radius:12px;
  overflow:auto;
  position:relative;
  /* NEW: fill available height and keep scroll within */
  flex:1;
  min-height:0;
}

table{border-collapse:separate;border-spacing:0;width:max-content;min-width:1200px;}
  th[data-key="insurance"],
td[data-key="insurance"] {
  min-width: 340px !important;
}


/* Header: white + slimmer + cyan underline */
thead th{
  position:sticky;
  top:0;
  background:#fff;
  z-index:5;
  font-size:12px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.02em;
  color:#49506a;
  padding:6px 10px;            /* NEW: narrower */
  min-height:36px;             /* NEW: shorter */
  border-bottom:2px solid var(--brand-cyan);
  user-select:none;
  cursor:pointer;
  text-align:center;
}
thead th.sortable::after{content:" ‚áÖ";font-size:10px;color:#999;margin-left:4px;}
thead th.sort-asc::after{content:" ‚ñ≤";}
thead th.sort-desc::after{content:" ‚ñº";}

/* Default center alignment for cells */
tbody td{
  padding:10px 12px;
  line-height:20px;
  min-height:44px;
  border-top:1px solid var(--line);
  vertical-align:middle;
  font-size:14px;
  max-width:280px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  text-align:center;
}

/* Long text cells left-aligned */
tbody td.trunc, tbody td.trunc-cell{
  text-align:left !important;
  cursor:pointer;
}

th.sticky, td.sticky{
  position:sticky;
  left:0;
  background:#fff;
  z-index:6;
  min-width:var(--stickyW);
  max-width:var(--stickyW);
  box-shadow:1px 0 0 var(--line);
}
/* Sticky NAME header stays white */
thead th.sticky{
  z-index:7;
  left:0;
  background:var(--thead);
}

tbody tr:hover td{background:#f8fafc}

/* Pills */
.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  background:var(--pill);
  color:var(--pillText);
  font-size:12px;
  line-height:18px;
}

.link{color:var(--link);text-decoration:none;font-weight:600}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}

/* Loader */
#loader{
  position:fixed;
  inset:0;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  color:#333;
  z-index:2000;
}
.spinner{
  width:48px;
  height:48px;
  border:4px solid #eee;
  border-top-color:var(--primary);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin-right:12px;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Loader with logo */
#loader .loader-inner{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
}
#loader .loader-logo{width:140px;height:auto;display:block;opacity:0;animation:fadeIn .6s ease-in forwards;}
#loader .loader-text{font-size:14px;color:#333;}
@keyframes fadeIn{to{opacity:1;}}

/* Popup */
#popup{
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  padding:16px 18px;
  border:1px solid var(--line);
  border-radius:10px;
  box-shadow:0 12px 30px rgba(0,0,0,.15);
  z-index:3000;
  max-width:700px;
  max-height:70vh;
  overflow:auto;
}
#popupClose{position:absolute;top:8px;right:12px;cursor:pointer;font-weight:700;}
#popup h4{margin:0 24px 10px 0;font-size:14px;color:#555;}
#popup pre{white-space:pre-wrap;word-break:break-word;font-family:inherit;font-size:14px;margin:0;}
.little-spinner{width:14px;height:14px;border:2px solid #e2e8f0;border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;}

/* Dimension hotfix (updated to fill viewport) */
.wrap{
  max-width:none;
  width:100%;
  padding:0 16px 16px;
  margin:16px auto 0;
  height:calc(100vh - 32px);
  display:flex;
  flex-direction:column;
}
.tableWrap{width:100%;}
@media (min-height:800px){ .tableWrap{max-height:unset;} }
@media (min-width:1600px){ .wrap{width:100%;} }

/* Record badge */
#recordBadge{
  display:flex;
  flex-direction:column;
  gap:6px;
  padding:6px 10px;
  background:#fff;
  border:1px solid var(--line);
  border-radius:12px;
  min-width:140px;
}
#recordText{font-size:14px;font-weight:600;color:#1f2937;}
#recordBar{
  position:relative;
  height:8px;
  background:#d1d5db;
  border-radius:999px;
  overflow:hidden;
}
#recordBarFill{
  height:100%;
  width:100%;
  background:var(--brand-coral);
  border-radius:999px;
  transition:width .25s ease;
}

/* Input focus accent */
input:focus, select:focus, button:focus{
  outline:2px solid var(--brand-cyan);
  box-shadow:0 0 0 3px rgba(0,181,200,0.18);
  border-radius:8px;
}
</style>

    
  </head>

  <body>
    <!-- Loader -->
    <div id="loader">
      <div class="loader-inner">
        <img
          src="./Link-zuruck-nach-oben.webp"
          alt="Epro 360 Logo"
          class="loader-logo"
        />
        <div class="spinner"></div>
        <div class="loader-text">Loading data‚Ä¶</div>
      </div>
    </div>

    <!-- Error banner -->
    <div
      id="errorBanner"
      style="display:none;margin:10px 0;padding:10px 12px;border:1px solid #f59e0b;background:#fff8e1;border-radius:8px;color:#7c2d12;font-size:13px"
    ></div>

    <div class="wrap" id="app" style="display:none">
      <div class="h1">Bachelor‚Äôs Programs ‚Äì Freshman Student</div>

      <!-- HIDE COLUMNS POPOVER -->
      <div class="popover" id="pvHide">
        <div class="pv-row"><label style="font-weight:600">Hide columns</label></div>
        <input id="hideSearch" type="text" placeholder="Find a field" />
        <div class="hide-list" id="hideList"></div>
        <div class="pv-actions">
          <button class="btn" id="hideAllBtn">Hide all</button>
          <div class="spacer"></div>
          <button class="btn" id="showAllBtn">Show all</button>
        </div>
      </div>

      <!-- FILTER POPOVER -->
      <div class="popover" id="pvFilter">
        <div class="pv-row"><label style="font-weight:600">Add conditions</label></div>
        <div id="condList"></div>
        <div class="pv-actions">
          <button class="btn" id="addCondBtn">+ Add condition</button>
          <div class="spacer"></div>
          <button class="btn" id="fltResetBtn">Reset</button>
          <button class="btn primary" id="fltApplyBtn">Apply</button>
        </div>
      </div>

      <!-- SORT POPOVER -->
      <div class="popover" id="pvSort">
        <div class="pv-row"><label style="font-weight:600">Sort by</label></div>
        <div class="pv-row-inline" id="sortRow">
          <select id="sortKey" style="min-width:240px"></select>
          <select id="sortDir" style="min-width:120px">
            <option value="asc">A ‚Üí Z</option>
            <option value="desc">Z ‚Üí A</option>
          </select>
        </div>
      </div>

      <!-- TABLE (toolbar moved inside) -->
      <div class="tableWrap" id="tableWrap">
        <!-- ======= TOOLBAR ======= -->
        <div class="toolbar" id="toolbar">
          <button class="tb-btn" id="tbHide">
            <svg class="tb-ico" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2">
              <path d="M3 3l18 18" />
              <path d="M10.6 10.6a2 2 0 102.8 2.8" />
              <path d="M9.9 4.2A9.9 9.9 0 0121 12c-.7 1.2-2.5 3.6-5.4 4.9M6.5 6.5C4 8 2.7 9.9 2 12c.7 1.8 2.7 4.5 6 6"/>
            </svg>
            Hide columns
          </button>

          <button class="tb-btn" id="tbFilter">
            <svg class="tb-ico" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2">
              <path d="M3 5h18l-7 8v6l-4-2v-4z"/>
            </svg>
            Filter
          </button>

          <button class="tb-btn" id="tbSort">
            <svg class="tb-ico" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2">
              <path d="M7 4v16M7 4l-3 3M7 4l3 3M17 20V4m0 16l-3-3m3 3l3-3"/>
            </svg>
            Sort
          </button>

          <!-- Progress badge pill (right-aligned) -->
          <span id="loadProgress" class="chip" style="display:none;margin-left:auto"></span>
        </div>
        <!-- ======= /TOOLBAR ======= -->

        <table id="tbl">
          <thead>
            <tr id="thead-row"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="chips" style="margin-top:8px">
        <span id="recordFooter" class="chip">0 universities</span>
      </div>
    </div>

    <!-- Popup for full cell text -->
    <div id="popup">
      <span id="popupClose">‚úï</span>
      <h4 id="popupTitle">Details</h4>
      <pre id="popupBody"></pre>
    </div>

    <script>
      (function(){
        // ===== COLUMNS ============================================================
        const COLUMNS = [
          { key:'name', title:'Name', sticky:true, sortable:true, type:'text', colId:'name' },
          { key:'photos_desc', title:'Photos & Description', type:'link', colId:'link4' },
          { key:'state', title:'State', sortable:true, type:'chip', colId:'state1', chipCategory:'state' },
          { key:'geo_area', title:'Geographical Area', sortable:true, type:'chip', colId:'dropdown30', chipCategory:'geo' },
          { key:'video_state', title:'Video I about the State', type:'link', colId:'link_14' },
          { key:'city', title:'City', trunc:true, type:'text', colId:'city' },
          { key:'address', title:'Full address', trunc:true, type:'mono', colId:'location' },
          { key:'virtual_tour', title:'Virtual Campus Tour?', type:'link', colId:'link_1' },

          /* STATUS & DROPDOWN ‚Äî ensure colored chips */
          { key:'fachabitur', title:'Fachabitur?', type:'chip', colId:'status5', chipCategory:'status' },
          { key:'fach_det', title:'Fachabitur Details', trunc:true, type:'text', colId:'long_text15' },

          { key:'usnews_rank', title:'U.S. News Ranking', align:'right', type:'mono', colId:'long_text' },
          { key:'usnews_link', title:'U.S. News Link', type:'link', colId:'link1' },

          { key:'type', title:'Type of Institution', type:'chip', colId:'dropdown' },

          { key:'enroll', title:'Total Enrollment', align:'right', type:'number',colId:'numbers7' },
          { key:'live_pct', title:'% Live on Campus', align:'right', type:'text', colId:'numbers8' },
          { key:'live_num', title:'# Live on Campus', align:'right', type:'number',colId:'formula5' },
          { key:'ratio', title:'Student-Faculty Ratio',align:'right',type:'number',colId:'numbers81' },

          /* Make dropdown Insurance a colored chip */
          { key:'insurance', title:'University Insurance Required?', type:'chip', colId:'dropdown8', chipCategory:'any' },
          { key:'insurance_info', title:'More Health Insurance Details', trunc:true, type:'text', colId:'long_text63' },

          { key:'app_fee', title:'Application Fee', align:'right', type:'text', colId:'temporary_university_s_application_fee_cost__usd_' },
          { key:'how_apply', title:'How to Apply', trunc:true, type:'text', colId:'long_text842' },

          { key:'cred_eval', title:'Credential Eval Required', type:'chip', colId:'status38', chipCategory:'status' },
          { key:'cred_info', title:'+Info on Credential Evaluation', trunc:true, type:'text', colId:'long_text60' },

          { key:'spring_adm', title:'Spring Admission?', type:'chip', colId:'status45', chipCategory:'status' },
          { key:'spring_sch', title:'Spring Scholarships?', type:'chip', colId:'status_13', chipCategory:'status' },

          { key:'clarify', title:'Clarification on Additional Information', trunc:true, type:'text', colId:'long_text9' },
          { key:'campus_acts', title:'On Campus Activities', type:'link', colId:'link2' },
          { key:'sports', title:'Sports Homepage', type:'link', colId:'link_198' },
          { key:'uni_home', title:'University Homepage', type:'link', colId:'link3' },
          { key:'intl_adm', title:'International Admission', type:'link', colId:'link0' },

          { key:'major', title:'Bachelor‚Äôs Study Areas', sortable:true, trunc:true, type:'text', colId:'dropdown73' },
          { key:'degrees_link', title:'Bachelor‚Äôs Degrees Link', type:'link', colId:'link30' },

          /* Make dropdown Academic Year a colored chip */
          { key:'acad_year', title:'Academic Year', type:'chip', colId:'dropdown4', chipCategory:'any' },

          /* Money + formulas (prefer backend-calculated fields) */
          { key:'tuition', title:'Tuition (Annual Cost in USD)', align:'right', type:'money', colId:'annual_tuition_cost' },
          { key:'room', title:'Room (Annual Cost in USD)', align:'right', type:'money', colId:'_usd__annual_room_cost' },
          { key:'board', title:'Board (Annual Cost in USD)', align:'right', type:'money', colId:'_usd__annual_board_cost' },
          { key:'fees', title:'Required Fees (Annual Cost in USD)', align:'right', type:'money', colId:'numbers5' },
          { key:'total', title:'TOTAL (Approximate Annual Cost in USD)', align:'right', type:'money', colId:'total_calc' },
          { key:'cost_info', title:'Additional Info and Link/s Annual Cost of Attendance', trunc:true, type:'text', colId:'link_s_annual_cost_of_attendance' },
          { key:'adm_req', title:'Admission Requirements', trunc:true, type:'text', colId:'_link__requirements_admission_information' },

          /* Scholarship thresholds + types (types are colored) */
          { key:'sch_low', title:'Lowest (USD) Annual Scholarship Amount', align:'right', type:'money', colId:'dup__of_minimum__usd__annual_scholarship_amount6' },
          { key:'sch_low_type', title:'Competitive vs Guaranteed? (Lowest)', type:'chip', colId:'status1', chipCategory:'status' },
          { key:'toefl_low', title:'TOEFL iBT Minimum (Lowest Scholarship)', align:'right', type:'number', colId:'numbers2' },
          { key:'gpa_low', title:'GPA Minimum (Lowest Scholarship)', align:'right', type:'number', colId:'numbers34' },
          { key:'sat_low', title:'SAT Minimum (Lowest Scholarship)', align:'right', type:'number', colId:'numbers0' },
          { key:'sch_low_info', title:'Additional Info and Link/s on Lowest Scholarship Amount (Lowest)', trunc:true, type:'text', colId:'additional_info_and_link_s_on_minimum_scholarship_amount' },

          { key:'sch_mid', title:'Mid-Range (USD) Annual Scholarship Amount (Mid-Range Scholarship)', align:'right', type:'money', colId:'numbers68' },
          { key:'sch_mid_type', title:'Competitive vs Guaranteed? (Mid-Range Scholarship)', type:'chip', colId:'status_132', chipCategory:'status' },
          { key:'toefl_mid', title:'TOEFL iBT Minimum (Most Probable Scholarship)', align:'right', type:'number', colId:'numbers54' },
          { key:'gpa_mid', title:'GPA Minimum (Most Probable Scholarship)', align:'right', type:'number', colId:'numbers64' },
          { key:'sat_mid', title:'SAT Minimum (Most Probable Scholarship)', align:'right', type:'number', colId:'numbers414' },
          { key:'sch_mid_info', title:'Additional Info and Link/s on Mid-Range Scholarship Amount (F) (Mid-Range Scholarship)', trunc:true, type:'text', colId:'long_text31' },

          { key:'sch_hi', title:'Highest (USD) Annual Scholarship Amount', align:'right', type:'money', colId:'numbers11' },
          { key:'sch_hi_type', title:'High: Type', type:'chip', colId:'dup__of_competitive_vs_guaranteed___gpa__3_5__highest_', chipCategory:'status' },
          { key:'toefl_hi', title:'TOEFL iBT Minimum (Highest Scholarship)', align:'right', type:'number', colId:'numbers70' },
          { key:'gpa_hi', title:'GPA Minimum (Highest Scholarship)', align:'right', type:'number', colId:'numbers4' },
          { key:'sat_hi', title:'SAT Minimum (Highest Scholarship)', align:'right', type:'number', colId:'numbers41' },
          { key:'sch_hi_info', title:'Additional Info and Link/s on Highest Scholarship Amount (Highest)', trunc:true, type:'text', colId:'long_text78' },

          /* Net costs ‚Äî backend ids */
          { key:'net_low', title:'(Lowest) Possible Net Cost of Attendance', align:'right', type:'money', colId:'net_low_calc' },
          { key:'net_mid', title:'(Mid-Range) Possible Net Cost of Attendance (F)', align:'right', type:'money', colId:'net_mid_calc' },
          { key:'net_hi', title:'(Highest) Possible Net Cost of Attendance', align:'right', type:'money', colId:'net_hi_calc' },

          { key:'dead_fall', title:'Fall Application Deadline', trunc:true, type:'text', colId:'deadline_fall_application' },
          { key:'dead_spring', title:'Spring Application Deadline', trunc:true, type:'text', colId:'deadline_spring_application' },
          { key:'dead_link', title:'Deadline Link', type:'link', colId:'link_104' },

          { key:'campus_job', title:'Campus Employment?', type:'chip', colId:'status_113', chipCategory:'status' },
          { key:'min_wage', title:'2025 Min Wage', align:'right', type:'money', colId:'numbers985' },

          /* Work comp ‚Äî backend calc (+fallback if 0/missing) */
          { key:'work_comp', title:'Annual Work on Campus Compensation (Most Probable)', align:'right', type:'money', colId:'work_comp_calc' },
          { key:'work_details_b', title:'Work on Campus Details', trunc:true, type:'text', colId:'long_text56' },
        ];

        const DEFAULT_FILTERABLE_KEYS = COLUMNS.map(c=>c.key);

        // --- global error surface
        window.addEventListener('error', function (e) {
          const b = document.getElementById('errorBanner');
          if (b) {
            b.textContent = 'Script error: ' + (e && e.message ? e.message : 'Unknown');
            b.style.display = 'block';
          }
          const l = document.getElementById('loader');
          if (l) l.style.display = 'none';
          const app = document.getElementById('app');
          if (app) app.style.display = 'block';
        });

        window.addEventListener('unhandledrejection', function (e) {
          const b = document.getElementById('errorBanner');
          const msg = e && e.reason ? (e.reason.message || String(e.reason)) : 'Unknown promise rejection';
          if (b) {
            b.textContent = 'Runtime error: ' + msg;
            b.style.display = 'block';
          }
          const l = document.getElementById('loader');
          if (l) l.style.display = 'none';
          const app = document.getElementById('app');
          if (app) app.style.display = 'block';
        });

        // --------- UI refs
        const app = document.getElementById('app');
        const loader = document.getElementById('loader');
        const tbody = document.getElementById('tbody');
        const theadRow = document.getElementById('thead-row');
        const shown = document.getElementById('shown');
        const loaded = document.getElementById('loaded');
        const recordText = document.getElementById('recordText');
        const recordBarFill = document.getElementById('recordBarFill');
        const recordFooter = document.getElementById('recordFooter');
        const noun = (n) => (n === 1 ? 'university' : 'universities');

        // Progress badge
        const loadProgress = document.getElementById('loadProgress');
        let totalItems = null;

        // Table wrap & table
        const tableWrap = document.getElementById('tableWrap');
        const tbl = document.getElementById('tbl');

        // Buttons (optional in DOM; guarded below)
        const reloadBtn = document.getElementById('reloadBtn');
        const reloadSpin = document.getElementById('reloadSpin');
        const moreBtn = document.getElementById('moreBtn');
        const moreSpin = document.getElementById('moreSpin');

        // Popovers + toolbar buttons
        const tbHide = document.getElementById('tbHide');
        const tbFilter = document.getElementById('tbFilter');
        const tbSort = document.getElementById('tbSort');
        const pvHide = document.getElementById('pvHide');
        const pvFilter = document.getElementById('pvFilter');
        const pvSort = document.getElementById('pvSort');

        // Hide columns refs
        const hideSearch = document.getElementById('hideSearch');
        const hideList = document.getElementById('hideList');
        const hideAllBtn = document.getElementById('hideAllBtn');
        const showAllBtn = document.getElementById('showAllBtn');

        // Filter (multi-rule)
        const fltApplyBtn = document.getElementById('fltApplyBtn');
        const fltResetBtn = document.getElementById('fltResetBtn');
        const addCondBtn = document.getElementById('addCondBtn');
        const condList = document.getElementById('condList');
        let rules = []; // { col, op, val }

        // Sort
        const sortKeySel = document.getElementById('sortKey');
        const sortDirSel = document.getElementById('sortDir');
        let sort = { key:null, dir:1 };

        // Hidden columns set
        const hidden = new Set();

        // Popup
        const popup = document.getElementById('popup');
        const popupTitle = document.getElementById('popupTitle');
        const popupBody = document.getElementById('popupBody');
        const popupClose = document.getElementById('popupClose');
        popupClose.onclick = () => popup.style.display = 'none';
        function openPopup(title, text){
          popupTitle.textContent = title || 'Details';
          popupBody.textContent = text || '';
          popup.style.display = 'block';
        }

        // --------- Color chip helpers
        function chipHTML(text, bg, border, fg){
          if (!text) return '';
          return '<span class="pill" style="background:'+bg+';border:1px solid '+border+';color:'+fg+';padding:4px 10px">'+esc(text)+'</span>';
        }

        const GEO_STYLES = {'Pacific West Coast':['#FFF4DB','#FFDFA6','#915930'],'West':['#FFE8EE','#FFC6D4','#8A2E45'],'Midwest':['#E7F7FF','#C8EFFF','#0B5586'],'Southeast':['#EFFFF3','#CCF3D7','#1F6B3A'],'Northeast':['#F1ECFF','#DDD6FE','#4A38A5'],'Southwest':['#FFF0E6','#FFD6BD','#884A1F']};

        /* UPDATED: default for status-like chips uses blue (no gray) */
        const STATUS_STYLES = {
          'shareable':['#E6F6EA','#BFE7C8','#256D3C'],
          'working on it':['#E6F0FF','#C9D7FF','#2746B3'],
          'in progress':['#E6F0FF','#C9D7FF','#2746B3'],
          'yes':['#E6F6EA','#BFE7C8','#256D3C'],
          'true':['#E6F6EA','#BFE7C8','#256D3C'],
          'no':['#FEEAEA','#F8C7C7','#9F1D1D'],
          'not shareable':['#FEEAEA','#F8C7C7','#9F1D1D'],
          'false':['#FEEAEA','#F8C7C7','#9F1D1D'],
          /* fallbacks ‚Üí blue */
          'unknown':['#E6F0FF','#C9D7FF','#2746B3'],
          'n/a':['#E6F0FF','#C9D7FF','#2746B3'],
          '':['#E6F0FF','#C9D7FF','#2746B3']
        };

        const TYPE_STYLES = {'Public':['#E7F7FF','#C8EFFF','#0B5586'],'Private':['#FFE8EE','#FFC6D4','#8A2E45'],'Community College':['#FFF4DB','#FFDFA6','#915930']};

        const STATE_HUES = [['#E6F6EA','#BFE7C8','#256D3C'],['#E6F0FF','#C9D7FF','#2746B3'],['#FFF4DB','#FFDFA6','#915930'],['#F1ECFF','#DDD6FE','#4A38A5'],['#E7F7FF','#C8EFFF','#0B5586'],['#FFE8EE','#FFC6D4','#8A2E45'],['#EFFFF3','#CCF3D7','#1F6B3A'],['#FFF0E6','#FFD6BD','#884A1F'],['#F2F4F7','#E6E9F0','#49506A'],['#EAF3FF','#CFE2FF','#23498C'],['#FDEBF6','#F8CDE8','#8F2D6A'],['#EAFBF7','#CFF3EA','#176D63']];

        function hashIndex(str){
          let h=0; str=String(str||'');
          for(let i=0;i<str.length;i++){ h=(h*31 + str.charCodeAt(i))|0; }
          if(h<0) h=-h;
          return h % STATE_HUES.length;
        }

        /* NEW: generic hashed colors for any dropdown-like chip */
        function chipByHash(text){
          const [bg,bd,fg] = STATE_HUES[hashIndex(text)];
          return chipHTML(text, bg, bd, fg);
        }

        // === NEW: deterministic HSL color for ANY label (unique per option) ===
        function colorFromText(text){
  let hash = 0;
  const s = String(text || '');
  for (let i = 0; i < s.length; i++){
    hash = s.charCodeAt(i) + ((hash << 5) - hash);
  }
  const hue = Math.abs(hash) % 360;
  const nudge = 8; // small shift to avoid overlap with brand hues
  const safeHue = (hue + nudge) % 360;
  const bg = `hsl(${safeHue}, 45%, 80%)`; // softer background
  const bd = `hsl(${safeHue}, 45%, 70%)`; // slightly darker border
  const fg = '#333'; // dark text for readability
  return [bg, bd, fg];
}

        function chipsFor(val, category){
          if (!val) return '';
          const parts = String(val).split(',').map(s=>s.trim()).filter(Boolean);
          let out = '';
          for (const p of parts){
            // Keep your special palette for GEO if available‚Ä¶
            if (category==='geo' && GEO_STYLES[p]) {
              const [bg,bd,fg] = GEO_STYLES[p];
              out += chipHTML(p, bg, bd, fg) + ' ';
              continue;
            }
            // ‚Ä¶otherwise auto-generate a unique color for every option
            const [bg, bd, fg] = colorFromText(p);
            out += chipHTML(p, bg, bd, fg) + ' ';
          }
          return out.trim();
        }

        // --------- Helpers
        function safeReplaceAll(str, search, repl){ return String(str).split(search).join(repl); }

        function readCell(item, colId){
          const cvs = item && item.column_values ? item.column_values : null;
          if (!cvs) return "";
          const v = cvs.find(c=>c.id===colId);
          if (!v) return "";
          const t = v.type;
          if (t === "text" || t === "long-text") return v.text || "";
          if (t === "dropdown") return safeReplaceAll(v.text || "", ";", ", ");
          if (t === "status") return v.text || "";
          if (t === "numbers") return v.text || v.value || "";
          if (t === "link") return v.text || v.url || "";
          if (t === "location") return v.text || "";
          if (t === "formula") return v.text || "";
          return v.text || "";
        }

        function numberFrom(a){
          if(a==null) return null;
          const s = (""+a).replace(/[^\d.\-]/g,'');
          if(!s) return null;
          const n = parseFloat(s);
          return Number.isFinite(n)?n:null;
        }

        function formatMoney(n){
          if(n==null || n==="") return "";
          try{
            return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n);
          } catch{
            return "$"+n;
          }
        }

        function formatInt(n){
          if(n==null || n==="") return "";
          try{
            return new Intl.NumberFormat('en-US',{maximumFractionDigits:0}).format(n);
          } catch{
            return String(n);
          }
        }

        function esc(s){
          return (s==null?"":String(s)).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }

        // --------- Dynamic columns (respect hidden set)
        function visibleCols(){ return COLUMNS.filter(c => !hidden.has(c.key)); }

        function buildThead(){
          const cols = visibleCols();
          theadRow.innerHTML = cols.map(col=>{
            const cls = [
              col.sticky ? 'sticky':'',
              col.sortable ? 'sortable':'',
              col.align==='right' ? 'right':''
            ].filter(Boolean).join(' ');
            return `<th class="${cls}" data-key="${esc(col.key)}">${esc(col.title)}</th>`;
          }).join('');
        }

        // --------- Filter (multi-rule) UI
        function columnOptionsHTML(selectedKey){
          return ['<option value="">Select a column‚Ä¶</option>']
            .concat(COLUMNS.map(c => `<option value="${esc(c.key)}"${c.key===selectedKey?' selected':''}>${esc(c.title)}</option>`))
            .join('');
        }

        function operatorOptionsHTML(selectedOp){
          const ops = [['contains','contains‚Ä¶'],['notcontains','does not contain‚Ä¶'],['is','is‚Ä¶'],['isnot','is not‚Ä¶'],['starts','starts with‚Ä¶'],['ends','ends with‚Ä¶'],['empty','is empty'],['notempty','is not empty']];
          return ops.map(([v,l])=>`<option value="${v}"${v===selectedOp?' selected':''}>${l}</option>`).join('');
        }

        function rowHTML(rule, idx){
          const valInput = (rule.op==='empty' || rule.op==='notempty')
            ? `<input class="cond-val" type="text" value="" disabled />`
            : `<input class="cond-val" type="text" value="${esc(rule.val||'')}" placeholder="value‚Ä¶" />`;
          return `
            <div class="cond-row" data-idx="${idx}">
              <select class="cond-col">${columnOptionsHTML(rule.col)}</select>
              <select class="cond-op">${operatorOptionsHTML(rule.op||'contains')}</select>
              ${valInput}
              <button type="button" class="btn cond-del" title="Remove">üóëÔ∏è</button>
            </div>
          `;
        }

        function rebuildConditionsUI(){
          condList.innerHTML = rules.map(rowHTML).join('');
          condList.querySelectorAll('.cond-row').forEach(rowEl=>{
            const idx = +rowEl.getAttribute('data-idx');
            const colSel = rowEl.querySelector('.cond-col');
            const opSel = rowEl.querySelector('.cond-op');
            const valInp = rowEl.querySelector('.cond-val');
            const delBtn = rowEl.querySelector('.cond-del');

            colSel.addEventListener('change', e=>{
              rules[idx].col = e.target.value || '';
            });

            opSel.addEventListener('change', e=>{
              rules[idx].op = e.target.value || 'contains';
              const needsVal = !(rules[idx].op==='empty' || rules[idx].op==='notempty'); // fixed
              if (valInp) {
                valInp.disabled = !needsVal;
                if (!needsVal) valInp.value = '';
              }
            });

            if (valInp){
              valInp.addEventListener('input', e=>{
                rules[idx].val = e.target.value || '';
              });
            }

            delBtn.addEventListener('click', ()=>{
              rules.splice(idx,1);
              rebuildConditionsUI();
            });
          });
        }

        function addRule(){
          rules.push({ col:'', op:'contains', val:'' });
          rebuildConditionsUI();
        }

        if (addCondBtn) addCondBtn.addEventListener('click', addRule);

        // Filter popover toggle
        if (tbFilter && pvFilter){
          tbFilter.addEventListener('click', (e)=>{
            e.stopPropagation();
            pvFilter.classList.toggle('open');
            if (pvFilter.classList.contains('open')){
              if (rules.length===0) addRule();
              const r = tbFilter.getBoundingClientRect();
              pvFilter.style.left = (r.left) + 'px';
              pvFilter.style.top = (r.bottom + window.scrollY + 8) + 'px';
              const firstSel = condList.querySelector('.cond-row .cond-col');
              if (firstSel) setTimeout(()=>firstSel.focus(), 0);
            }
          });
        }

        document.addEventListener('click', (e)=>{
          if (!pvFilter.contains(e.target) && e.target !== tbFilter) pvFilter.classList.remove('open');
          if (!pvHide.contains(e.target) && e.target !== tbHide) pvHide.classList.remove('open');
          if (!pvSort.contains(e.target) && e.target !== tbSort) pvSort.classList.remove('open');
        });

        document.addEventListener('keydown', (e)=>{
          if (e.key === 'Escape'){
            pvFilter.classList.remove('open');
            pvHide.classList.remove('open');
            pvSort.classList.remove('open');
          }
        });

        if (fltApplyBtn){
          fltApplyBtn.addEventListener('click', ()=>{
            pvFilter.classList.remove('open');
            render();
          });
        }

        if (fltResetBtn){
          fltResetBtn.addEventListener('click', ()=>{
            rules = [];
            rebuildConditionsUI();
            pvFilter.classList.remove('open');
            render();
          });
        }

        // --------- Hide columns UI
        function drawHideList(){
          const q = (hideSearch.value||'').toLowerCase();
          const rows = COLUMNS
            .filter(c => c.key!=='name')
            .filter(c => c.title.toLowerCase().includes(q) || c.key.toLowerCase().includes(q))
            .map(c=>{
              const on = !hidden.has(c.key);
              return `
                <div class="hide-row" data-key="${esc(c.key)}">
                  <div class="switch ${on?'on':''}" aria-label="toggle ${esc(c.title)}" role="switch" aria-checked="${on?'true':'false'}"></div>
                  <div class="hide-name">${esc(c.title)}</div>
                </div>
              `;
            }).join('');
          hideList.innerHTML = rows || '<div class="muted" style="padding:6px 2px">No matches</div>';

          hideList.querySelectorAll('.hide-row .switch').forEach(sw=>{
            sw.addEventListener('click', ()=>{
              const key = sw.parentElement.getAttribute('data-key');
              if (hidden.has(key)) hidden.delete(key);
              else hidden.add(key);
              sw.classList.toggle('on');
              sw.setAttribute('aria-checked', sw.classList.contains('on')?'true':'false');
              buildThead();
              attachSortHandlers();
              render();
            });
          });
        }

        if (tbHide){
          tbHide.addEventListener('click', (e)=>{
            e.stopPropagation();
            pvHide.classList.toggle('open');
            if (pvHide.classList.contains('open')){
              const r = tbHide.getBoundingClientRect();
              pvHide.style.left = (r.left) + 'px';
              pvHide.style.top = (r.bottom + window.scrollY + 8) + 'px';
              drawHideList();
              hideSearch.focus();
            }
          });
        }

        hideSearch.addEventListener('input', drawHideList);

        hideAllBtn.addEventListener('click', ()=>{
          COLUMNS.forEach(c=>{
            if(c.key!=='name') hidden.add(c.key);
          });
          drawHideList();
          buildThead();
          attachSortHandlers();
          render();
        });

        showAllBtn.addEventListener('click', ()=>{
          hidden.clear();
          drawHideList();
          buildThead();
          attachSortHandlers();
          render();
        });

        // --------- Sort (A‚ÜíZ / Z‚ÜíA) UI
        function initSortUI(){
          sortKeySel.innerHTML = ['<option value="">Name</option>']
            .concat(
              COLUMNS
                .filter(c=>c.sortable || c.type==='text' || c.type==='money' || c.type==='number')
                .map(c=>`<option value="${esc(c.key)}">${esc(c.title)}</option>`)
            ).join('');
          sortKeySel.addEventListener('change', e=>{
            const k=e.target.value||'name';
            sort.key=k;
            render();
          });
          sortDirSel.addEventListener('change', e=>{
            sort.dir = (e.target.value==='asc')?1:-1;
            render();
          });
        }

        if (tbSort){
          tbSort.addEventListener('click', (e)=>{
            e.stopPropagation();
            pvSort.classList.toggle('open');
            if (pvSort.classList.contains('open')){
              const r = tbSort.getBoundingClientRect();
              pvSort.style.left = (r.left) + 'px';
              pvSort.style.top = (r.bottom + window.scrollY + 8) + 'px';
              if (!sort.key) sort.key = 'name';
              initSortUI();
              sortKeySel.value = sort.key || '';
              sortDirSel.value = sort.dir===1 ? 'asc' : 'desc';
            }
          });
        }

        function applySort(arr){
          if(!sort.key) return;
          const meta = COLUMNS.find(c=>c.key===sort.key) || COLUMNS.find(c=>c.key==='name');
          const d = sort.dir;
          const type = meta && (meta.type==='money' || meta.type==='number') ? 'number':'text';
          arr.sort((a,b)=>{
            let va = a[sort.key], vb = b[sort.key];
            if (type==='number'){
              const na = numberFrom(va), nb = numberFrom(vb);
              if(na!=null && nb!=null) return (na-nb)*d;
            }
            return String(va||'').localeCompare(String(vb||''))*d;
          });
        }

        function updateSortIndicators(){
          document.querySelectorAll('thead th').forEach(th=>{
            th.classList.remove('sort-asc','sort-desc');
            const key = th.getAttribute('data-key');
            if(key && key === sort.key) th.classList.add(sort.dir===1?'sort-asc':'sort-desc');
          });
        }

        function attachSortHandlers(){
          document.querySelectorAll('thead th').forEach(th=>{
            const key = th.getAttribute('data-key');
            if (COLUMNS.find(c=>c.key===key)){
              th.addEventListener('click', ()=>{
                if (sort.key===key) sort.dir*=-1;
                else { sort.key=key; sort.dir=1; }
                sortKeySel && (sortKeySel.value = sort.key);
                sortDirSel && (sortDirSel.value = sort.dir===1?'asc':'desc');
                render();
              });
            }
          });
        }

        // --------- Map item -> row object
        function itemToRow(item){
          const row = {};
          for (const col of COLUMNS){
            if (hidden.has(col.key)) continue;
            let raw;
            if (col.key==='name') {
              raw = (item && item.name ? item.name : '');
            } else if (Object.prototype.hasOwnProperty.call(item, col.colId)) {
              raw = item[col.colId];
            } else {
              raw = readCell(item, col.colId);
            }

            /* Fallback compute for work_comp if 0/missing */
            if (col.key === 'work_comp'){
              let n = numberFrom(raw);
              if (n == null || n === 0){
                const wageRaw = Object.prototype.hasOwnProperty.call(item, 'numbers985') ? item['numbers985'] : readCell(item, 'numbers985');
                const wage = numberFrom(wageRaw);
                if (wage != null && wage > 0){
                  n = wage * 10 * 32; // 10 hrs/week * 32 weeks
                }
              }
              raw = n;
            }

            if (col.type==='number' || col.type==='money') raw = numberFrom(raw);
            row[col.key] = raw;
          }
          return row;
        }

        // --------- Cell renderer
        function renderCell(col, val){
          const title = col.title;
          if (col.type==='link') return truncCell(val, title);
          if (col.type==='mono') return `<span class="trunc mono" data-title="${esc(title)}" data-full="${esc(val||'')}">${esc(val||'')}</span>`;
          if (col.type==='chip') return chipsFor(val, col.chipCategory);
          if (col.type==='money') return (val==null? '' : formatMoney(val));
          if (col.type==='number') return (val==null? '' : formatInt(val));
          if (col.trunc===true) return `<span class="trunc" data-title="${esc(title)}" data-full="${esc(val||'')}">${esc(val||'')}</span>`;
          return esc(val||'');
        }

        function truncCell(content, title){
          const full = (content==null?"":String(content)).trim();
          if(!full) return '';
          const urlMatch = full.match(/https?:\/\/\S+/);
          if(urlMatch) return '<a class="link" href="'+esc(urlMatch[0])+'" target="_blank" rel="noopener">Link</a>';
          return '<span class="trunc" data-title="'+esc(title||'Details')+'" data-full="'+esc(full)+'">'+esc(full)+'</span>';
        }

        // --------- Data & state
        let items = [];
        let cursor = null;
        let isLoading = false;

        // --------- Filtering logic (multi-rule, AND)
        function passesAll(row){
          if (!rules || !rules.length) return true;
          for (const r of rules){
            const key = (r.col||'').trim();
            if (!key) return true;
            const cell = row[key];
            const s = (cell==null ? '' : String(cell)).toLowerCase();
            const v = String(r.val || '').toLowerCase();
            switch (r.op){
              case 'contains': if (!v || s.indexOf(v) !== -1) break; else return false;
              case 'notcontains': if (!v || s.indexOf(v) === -1) break; else return false;
              case 'is': if (s === v) break; else return false;
              case 'isnot': if (s !== v) break; else return false;
              case 'starts': if (!v || s.lastIndexOf(v, 0) === 0) break; else return false;
              case 'ends': if (!v || s.slice(-v.length) === v) break; else return false;
              case 'empty': if (s.trim() === '') break; else return false;
              case 'notempty': if (s.trim() !== '') break; else return false;
              default: break;
            }
          }
          return true;
        }

        // --------- Render table
        function render(){
          const rows = items.map(itemToRow);

          // Apply filters
          const filtered = rows.filter(passesAll);

          // Update counters
          if (recordText) recordText.textContent = `${filtered.length} records`; // fixed
          if (shown) shown.textContent = filtered.length + ' shown';
          if (loaded) loaded.textContent = items.length + ' loaded';

          // Sort + draw
          applySort(filtered);
          updateSortIndicators();

          const cols = visibleCols();
          let html = '';
          for (const r of filtered){
            html += '<tr>';
            for (const col of cols){
              const val = r[col.key];
              const cls = [
                col.sticky ? 'sticky':'',
                col.align==='right' ? 'right':'',
                col.trunc ? 'trunc-cell':''
              ].filter(Boolean).join(' ');
              const tdClass = cls ? ` class="${cls}"` : '';
              html += `<td${tdClass}>${renderCell(col, val)}</td>`;
            }
            html += '</tr>';
          }
          tbody.innerHTML = html;

          // Update footer chip
          if (recordFooter) {
            recordFooter.textContent = `${filtered.length} ${noun(filtered.length)}`; // fixed
          }

          // Show/hide ‚ÄúLoad more‚Äù if present
          const hasCursor = !!cursor;
          if (moreBtn) moreBtn.style.display = hasCursor ? 'inline-flex' : 'none';

          // Update progress badge
          updateProgressBadge();
        } // end render()

        // Progress badge updater
        function updateProgressBadge(){
          if (!loadProgress) return;
          const loadedCount = items.length;
          if (totalItems != null) {
            loadProgress.textContent = `${loadedCount} / ${totalItems} loaded`; // fixed
          } else {
            loadProgress.textContent = `${loadedCount} loaded`; // fixed
          }
          const done = !cursor;
          loadProgress.style.display = done ? 'none' : 'inline-block';
        }

        // Delegated click for popup (for .trunc spans) ‚Äî single listener
        tbody.addEventListener('click', (e)=>{
          let target = e.target;
          while (target && target !== tbody && !target.classList.contains('trunc')) target = target.parentNode;
          if (!target || target === tbody) return;
          const title = target.getAttribute('data-title') || 'Details';
          const full = target.getAttribute('data-full') || target.textContent || '';
          if (String(full).trim()) openPopup(title, full);
        });

        // Controls (if present)
        if (reloadBtn) reloadBtn.onclick = ()=>{
          if(isLoading) return;
          initialLoad();
        };

        if (moreBtn) moreBtn.onclick = ()=>{
          if(isLoading || !cursor) return;
          fetchAndAppend({limit: 100, cursorParam: cursor, progressive: true});
        };

        // Data fetching
        async function fetchBatch(params){
          const errorBanner = document.getElementById('errorBanner');
          const base = location.origin || window.location.href;
          const url = new URL('/.netlify/functions/items', base);

          // defaults
          url.searchParams.set('limit', String(params && params.limit ? params.limit : '100'));
          if (params && params.cursorParam) url.searchParams.set('cursor', params.cursorParam);

          // pass through progressive + min + maxPages
          if (params && params.progressive) url.searchParams.set('progressive', 'true');
          if (params && params.min != null) url.searchParams.set('min', String(params.min));
          if (params && params.maxPages != null) url.searchParams.set('maxPages', String(params.maxPages));

          try {
            const resp = await fetch(url.toString(), { cache: 'no-store' });
            if (!resp.ok) {
              let txt='';
              try{ txt = await resp.text(); }catch(_){}
              throw new Error('HTTP '+resp.status+': '+String(txt).slice(0,300));
            }
            const json = await resp.json();

            // pick up a total count if backend provides it
            if (json && typeof json.total === 'number') {
              totalItems = json.total;
            }

            if (!json || !Array.isArray(json.items)) throw new Error('Unexpected payload: '+JSON.stringify(json).slice(0,300));
            if (errorBanner) errorBanner.style.display = 'none';
            return json;
          } catch (e) {
            console.error('Fetch failed', e);
            if (errorBanner) {
              errorBanner.textContent = 'Could not load data. ' + (e && e.message ? e.message : String(e));
              errorBanner.style.display = 'block';
            }
            // Hide progress badge on error so it never gets stuck
            if (loadProgress) loadProgress.style.display = 'none';
            return { items: [], cursor: null };
          }
        }

        async function fetchAndAppend(opts){
          setMoreLoading(true);
          const res = await fetchBatch(opts || {});
          const batch = res.items || [];
          const cur = res.cursor || null;

          if (batch.length){
            items.push(...batch);
            render();
          }
          cursor = cur;

          while (opts && opts.progressive && cursor){
            const resN = await fetchBatch({limit:100, cursorParam: cursor});
            const nextBatch = resN.items || [];
            const nextCur = resN.cursor || null;
            if (nextBatch.length){
              items.push(...nextBatch);
              render();
            }
            cursor = nextCur;
          }

          setMoreLoading(false);
          updateProgressBadge();
        }

        function showLoader(on){
          if (loader) loader.style.display = on ? 'flex' : 'none';
        }

        function setMoreLoading(on){
          isLoading = on;
          if (moreBtn) moreBtn.disabled = on;
          if (reloadBtn) reloadBtn.disabled = on;
          if (moreSpin) moreSpin.style.display = on ? 'inline-block' : 'none';
          if (reloadSpin) reloadSpin.style.display = on ? 'inline-block' : 'none';
          const span = moreBtn ? moreBtn.querySelector('span') : null;
          if (span) span.textContent = on ? 'Load more‚Ä¶' : 'Load more';
          if (recordBarFill) recordBarFill.style.width = on ? '40%' : '100%';
        }

        // --------- Init
        function initialHeadersAndUI(){
          buildThead();
          attachSortHandlers();
          initSortUI();
          // Default sort by Name asc
          sort = { key:'name', dir:1 };
          sortKeySel && (sortKeySel.value = 'name');
          sortDirSel && (sortDirSel.value = 'asc');
        }

        async function initialLoad(){
          items = [];
          cursor = null;
          totalItems = null; // reset total for a fresh session

          showLoader(true);
          try {
            // First page only; return fast
            const FIRST_PAGE_LIMIT = 50;
            const MIN_FIRST = 10;
            const first = await fetchBatch({ limit: FIRST_PAGE_LIMIT, min: MIN_FIRST });
            const batch1 = first.items || [];
            if (batch1.length){
              items.push(...batch1);
              render();
            }
            cursor = first.cursor || null;

            // Reveal UI immediately after first page
            showLoader(false);
            if (app) app.style.display = 'block';

            // Keep fetching more pages in the background
            const PROGRESS_LIMIT = 120;
            while (cursor){
              const next = await fetchAndAppend({ limit: PROGRESS_LIMIT, cursorParam: cursor, progressive: true });
              cursor = next && next.cursor || cursor;
            }
          } finally {
            showLoader(false);
            if (app) app.style.display = 'block'; // final ensure
            updateProgressBadge();
          }
        }

        // start
        initialHeadersAndUI();
        initialLoad();
      })();
    </script>
  </body>
</html>
