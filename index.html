<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Epro 360 – Bachelor’s Programs (read-only)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f7fb;            /* monday hell */
    --card:#ffffff;
    --text:#323338;
    --muted:#676879;
    --border:#e6e9ef;
    --accent:#0073ea;        /* monday blue */
    --pill:#cce5ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--text); background:var(--bg);
  }
  .wrap{max-width:1220px; margin:32px auto; padding:0 16px;}
  h1{font-size:24px; font-weight:700; margin:0 0 10px}
  .hint{color:var(--muted); font-size:13px; margin-bottom:16px}

  .toolbar{
    display:flex; gap:12px; flex-wrap:wrap;
    background:var(--card); border:1px solid var(--border);
    padding:12px; border-radius:10px; align-items:center;
    margin-bottom:12px;
  }
  .tool{display:flex; gap:8px; align-items:center}
  label{font-size:12px; color:var(--muted)}
  input, select{
    height:34px; padding:0 10px; border:1px solid var(--border);
    border-radius:8px; background:#fff; color:var(--text);
    min-width:140px;
  }
  .btn{
    height:34px; padding:0 12px; border:1px solid var(--accent);
    background:var(--accent); color:#fff; border-radius:8px;
    font-weight:600; cursor:pointer;
  }
  .btn.sec{background:#fff; color:var(--accent)}
  .chips{display:flex; gap:8px; align-items:center; margin:8px 0 14px}
  .chip{padding:6px 10px; background:#eef6ff; color:#1f6feb; border-radius:999px; font-size:12px}

  table{width:100%; border-collapse:collapse; background:var(--card);
    border:1px solid var(--border); border-radius:12px; overflow:hidden}
  thead th{
    text-align:left; font-size:12px; text-transform:uppercase; letter-spacing:.02em;
    color:var(--muted); background:#f8f9fb; padding:12px 14px; border-bottom:1px solid var(--border)
  }
  tbody td{padding:14px; border-bottom:1px solid var(--border)}
  tbody tr:hover{background:#fafbfe}
  .name{font-weight:600}
  .pill{padding:4px 8px; background:var(--pill); color:#064d8c; border-radius:999px; font-size:12px}
  .num{text-align:right; font-variant-numeric:tabular-nums}
  .footer{
    display:flex; justify-content:space-between; align-items:center; margin-top:10px
  }
  .sp{color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Bachelor’s Programs – Freshman &amp; Average Student</h1>
    <div class="hint">Die Daten kommen aus einer sicheren Netlify-Funktion (read-only).</div>

    <div class="toolbar">
      <div class="tool">
        <label>Suche (Name &amp; Major)</label>
        <input id="q" placeholder="Search…" />
      </div>
      <div class="tool">
        <label>State</label>
        <select id="state">
          <option value="all">Alle</option>
          <!-- Wird dynamisch befüllt -->
        </select>
      </div>
      <div class="tool">
        <label>Ranking</label>
        <input id="rMin" type="number" placeholder="min">
        <input id="rMax" type="number" placeholder="max">
      </div>
      <div class="tool">
        <label>Final cost (USD)</label>
        <input id="cMin" type="number" placeholder="min $">
        <input id="cMax" type="number" placeholder="max $">
      </div>
      <div class="tool">
        <label>Min GPA</label>
        <input id="gMin" type="number" step="0.01" placeholder="min">
        <input id="gMax" type="number" step="0.01" placeholder="max">
      </div>
      <div class="tool">
        <label>&nbsp;</label>
        <button class="btn" id="reload">Neu laden</button>
        <button class="btn sec" id="reset">Reset Filter</button>
      </div>
      <div class="tool">
        <label>Page size</label>
        <select id="pageSize">
          <option>20</option>
          <option selected>50</option>
          <option>100</option>
        </select>
        <button class="btn sec" id="loadMore">Mehr laden</button>
      </div>
    </div>

    <div class="chips">
      <span class="chip" id="shown">0 angezeigt</span>
      <span class="chip" id="loaded">0 geladen</span>
      <span class="chip" id="cursor">cursor: none</span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:36%">Name</th>
          <th style="width:14%">State</th>
          <th style="width:22%">Major</th>
          <th style="width:8%">Ranking</th>
          <th style="width:10%">Final cost</th>
          <th style="width:10%">Min GPA</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="footer">
      <div class="sp">Tip: Suche durchsucht Name &amp; Major Labels.</div>
      <div class="sp">Powered by Netlify Functions &amp; monday GraphQL</div>
    </div>
  </div>

<script>
const API = '/.netlify/functions/items';
let cursor = null;
let loaded = 0;
let dataset = []; // jeweils letzte Page (gefiltert von der Function)!

const $ = sel => document.querySelector(sel);

function fmtMoney(n){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n); }
function fmtNum(n){ return new Intl.NumberFormat('en-US').format(n); }

function readFilters(asPageSizeOnly=false){
  const limit = parseInt($('#pageSize').value, 10);
  if (asPageSizeOnly) return { limit };
  const params = {
    limit,
    q: $('#q').value.trim(),
    state: $('#state').value,
    rMin: $('#rMin').value,
    rMax: $('#rMax').value,
    cMin: $('#cMin').value,
    cMax: $('#cMax').value,
    gMin: $('#gMin').value,
    gMax: $('#gMax').value
  };
  Object.keys(params).forEach(k => { if (params[k]==='') delete params[k]; });
  return params;
}

async function fetchPage({ append=false } = {}){
  const p = readFilters();
  if (append && cursor) p.cursor = cursor;

  const qs = new URLSearchParams(p).toString();
  const res = await fetch(`${API}?${qs}`);
  const json = await res.json();

  cursor = json.cursor || null;
  dataset = append ? dataset.concat(json.items) : json.items;
  loaded += json.meta?.received ?? json.items.length;

  $('#loaded').textContent = `${loaded} geladen`;
  $('#cursor').textContent = `cursor: ${cursor ? 'more' : 'none'}`;

  render();
  // States für Filter befüllen
  initStateFilter(dataset);
}

function initStateFilter(items){
  const sel = $('#state');
  const current = sel.value || 'all';
  const pool = new Set();
  items.forEach(it => (it.state||'').split(',').map(s=>s.trim()).filter(Boolean).forEach(s=>pool.add(s)));
  const opts = ['all', ...[...pool].sort()];
  sel.innerHTML = opts.map(v => `<option value="${v}">${v}</option>`).join('');
  sel.value = current;
}

function render(){
  const tbody = $('#rows');
  tbody.innerHTML = dataset.map(it => `
    <tr>
      <td class="name">${it.name ?? ''}</td>
      <td><span class="pill">${it.state || '-'}</span></td>
      <td>${it.major || '-'}</td>
      <td class="num">${it.ranking!=null? fmtNum(it.ranking): '-'}</td>
      <td class="num">${it.final_cost!=null? fmtMoney(it.final_cost): '-'}</td>
      <td class="num">${it.min_gpa!=null? it.min_gpa.toFixed(2): '-'}</td>
    </tr>
  `).join('');
  $('#shown').textContent = `${dataset.length} angezeigt`;
}

$('#reload').addEventListener('click', async () => {
  cursor = null; loaded = 0; dataset = [];
  await fetchPage({ append:false });
});

$('#reset').addEventListener('click', async () => {
  ['q','rMin','rMax','cMin','cMax','gMin','gMax'].forEach(id => $('#'+id).value = '');
  $('#state').value = 'all';
  cursor = null; loaded = 0; dataset = [];
  await fetchPage({ append:false });
});

$('#loadMore').addEventListener('click', async () => {
  if (!cursor) return;
  await fetchPage({ append:true });
});

// erste Ladung
fetchPage();
</script>
</body>
</html>
